<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procedural Sedation Checklist & Record</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for form elements */
        label {
            @apply block text-sm font-medium text-gray-700;
        }
        
        /* NEW: Styling for "card-in-card" fieldsets */
        .section-box fieldset {
            @apply mt-6 bg-white border border-gray-300 rounded-lg p-4 shadow-sm;
        }
        .section-box fieldset:first-child {
            @apply mt-0; /* No top margin for the first fieldset in a box */
        }
        .section-box fieldset legend {
            @apply text-lg font-semibold text-gray-800 px-2;
        }
        /* Special style for the critical safety box */
        .critical-safety-box {
            @apply mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3;
        }
        
        /* NEW: Style for expandable guide content */
        .guide-content {
            @apply mt-2 p-4 bg-blue-50 border border-blue-200 rounded-lg;
        }

        /* Keep table input style simple */
        table input[type="text"] {
            @apply border-none focus:ring-0 p-2 w-full;
        }
        /* Style for disabled timestamp buttons */
        button:disabled {
            @apply bg-gray-300 cursor-not-allowed;
        }
        
        /* Styles for printing */
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: #ffffff;
            }
            .no-print {
                display: none !important;
            }
            .printable-container {
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
                max-width: 100%;
                background-color: #ffffff;
            }
            .section-box {
                 background-color: #f9fafb !important; /* Light gray for print */
                 border: 1px solid #e5e7eb !important;
                 box-shadow: none !important;
                 padding: 1rem !important;
            }
             .section-box fieldset {
                @apply bg-white; /* White cards inside gray box */
             }
            .section-header {
                background-color: #f3f4f6 !important; /* Slightly darker gray */
                border-bottom: 1px solid #e5e7eb !important;
            }
            .section-header-number {
                background-color: #dbeafe !important;
                color: #1e40af !important;
            }
            .critical-safety-box, .guide-content {
                background-color: #eff6ff !important;
                border: 1px solid #bfdbfe !important;
            }
            .mandatory-monitoring-item {
                color: #dc2626 !important;
                font-weight: 600 !important;
            }
            h1, h2, h3, h4, h5, h6 {
                color: #000 !important;
            }
            /* Break pages strategically */
            .page-break {
                page-break-before: always;
            }
            /* Ensure guides are visible for print */
            .guide-content.hidden {
                display: block !important;
            }
        }
        
        /* Modal Styles (REMOVED) */
        
        /* 5-Minute Obs Prompt Toast - RELOCATED */
        #obs-toast {
            @apply bg-yellow-400 text-black p-3 text-center font-bold shadow-md rounded-lg my-4 flex justify-between items-center no-print;
        }
        
        /* Complications list styling (now in guide-content) */
        .complications-list h4 {
            @apply text-lg font-semibold text-blue-700 mt-4 first:mt-0;
        }
        .complications-list p {
            @apply text-sm text-gray-600 mb-2;
        }
        .complications-list .management-steps {
            @apply list-decimal list-inside space-y-1 text-sm;
        }
        .complications-list .management-steps strong {
            @apply font-semibold text-gray-800;
        }

    </style>
</head>
<body class="bg-gray-200 font-sans">
    
    <!-- Main Form Content -->
    <main class="max-w-6xl mx-auto my-8 p-0 sm:p-6 printable-container">
        
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between sm:items-center pb-4 mb-8 px-6 sm:px-0">
            <div>
                <h1 class="text-3xl font-bold text-blue-900">Procedural Sedation Checklist & Record</h1>
                <p class="text-sm text-gray-600">Based on RCEM Best Practice Guidelines (2022)</p>
            </div>
            <img 
                src="https://iili.io/KGQOvkl.md.png" 
                alt="WMEBEM Logo" 
                class="h-16 w-auto mt-4 sm:mt-0"
                onerror="this.style.display='none'">
        </header>

        <form id="sedation-form">
            
            <!-- 1. Patient & Procedure Section Box -->
            <div class="bg-gray-50 sm:rounded-xl shadow-lg mb-8 overflow-hidden section-box">
                <div class="flex items-center bg-gray-100 border-b border-gray-200 p-4 section-header">
                    <div class="flex-shrink-0 bg-blue-500 rounded-full h-10 w-10 flex items-center justify-center section-header-number">
                        <span class="text-xl font-bold text-white">1</span>
                    </div>
                    <h2 class="text-2xl font-semibold text-blue-800 ml-4">Patient & Procedure</h2>
                </div>

                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="age">Age</label>
                            <input type="number" id="age" placeholder="e.g., 35" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label for="weight">Patient Weight (kg) <span class="text-red-500">*</span></label>
                            <div class="flex items-center gap-4">
                                <input type="number" id="weight" placeholder="e.g., 70" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <div class="flex items-center gap-2 mt-1">
                                    <input type="checkbox" id="weight-estimated" class="mt-0 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="weight-estimated">Estimated</label>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-3">
                            <label for="allergies">Allergies (and reaction)</label>
                            <input type="text" id="allergies" placeholder="e.g., Penicillin (rash), NKDA" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="md:col-span-3">
                            <label for="pre-analgesia">Pre-Sedation Analgesia Given</label>
                            <input type="text" id="pre-analgesia" placeholder="e.g., IV Morphine 10mg at 14:30" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="md:col-span-1">
                            <label for="procedure">Procedure</label>
                            <input type="text" id="procedure" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label for="indication">Indication for Sedation</label>
                            <input type="text" id="indication" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="sedationist">Sedationist</label>
                            <input type="text" id="sedationist" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="procedure-doctor">Procedure Doctor / Operator</label>
                            <input type="text" id="procedure-doctor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="nurse">Monitoring Nurse</label>
                            <input type="text" id="nurse" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                
                    <!-- Dose Guide -->
                    <section class="mt-6 no-print">
                        <fieldset>
                            <legend class="text-lg font-semibold text-blue-700 px-2">Estimated Dose Guide (Adults)</legend>
                            <p class="text-xs text-red-600 font-semibold mb-3">DISCLAIMER: This is a GUIDE only. Doses must be titrated to clinical effect. Clinician judgement is final.</p>
                            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                                <div class="flex-shrink-0">
                                    <input type="checkbox" id="frail-elderly" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="frail-elderly" class="font-medium">Frail / Elderly (>65)</label>
                                </div>
                                <button type="button" id="calculate-doses-button" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Calculate Dose Ranges</button>
                            </div>
                            <div id="dose-output" class="mt-4 p-4 bg-blue-50 rounded-md hidden font-mono">
                                <!-- Dose calculator output goes here -->
                            </div>
                        </fieldset>
                    </section>
                </div>
            </div> <!-- End Section 1 Box -->

            <!-- 2. Pre-Sedation Assessment Section Box -->
            <div class="bg-gray-50 sm:rounded-xl shadow-lg mb-8 overflow-hidden section-box">
                <div class="flex items-center bg-gray-100 border-b border-gray-200 p-4 section-header">
                    <div class="flex-shrink-0 bg-blue-500 rounded-full h-10 w-10 flex items-center justify-center section-header-number">
                        <span class="text-xl font-bold text-white">2</span>
                    </div>
                    <h2 class="text-2xl font-semibold text-blue-800 ml-4">Pre-Sedation Assessment</h2>
                </div>

                <div class="p-6">
                    <!-- This section is now a single column -->
                    
                    <!-- Consent -->
                    <fieldset>
                        <legend>Consent & Risks Discussed</legend>
                        <div class="mt-2 space-y-2">
                            <div class="flex items-start gap-2">
                                <input id="consent-obtained" name="consent-obtained" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1">
                                <label for="consent-obtained" class="text-sm font-medium text-gray-700">Informed consent (verbal/written) obtained and documented.</label>
                            </div>
                            <hr class="my-3 pt-1 border-gray-200">
                            <div class="flex items-start gap-2"><input id="risk-nausea" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="risk-nausea" class="text-sm">Nausea or vomiting (Common, ~1 in 20)</label></div>
                            <div class="flex items-start gap-2"><input id="risk-bp" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="risk-bp" class="text-sm">Temporary drop in BP / breathing (Common)</label></div>
                            <div class="flex items-start gap-2"><input id="risk-emergence" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="risk-emergence" class="text-sm">Agitation/dreams (Uncommon, ~1 in 50, esp. Ketamine)</label></div>
                            <div class="flex items-start gap-2"><input id="risk-severe-breathing" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="risk-severe-breathing" class="text-sm">Significant breathing problems (Uncommon, ~1 in 500)</label></div>
                            <div class="flex items-start gap-2"><input id="risk-aspiration" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="risk-aspiration" class="text-sm">Aspiration (Rare, ~1 in 2,000)</label></div>
                            <div class="flex items-start gap-2"><input id="risk-allergy" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="risk-allergy" class="text-sm">Serious allergic reaction (Very Rare, ~1 in 10,000)</label></div>
                            <div class="flex items-start gap-2"><input id="risk-major" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="risk-major" class="text-sm">Major complication (cardiac arrest, death) (Extremely Rare)</label></div>
                        </div>
                    </fieldset>

                    <!-- Fasting Status -->
                    <fieldset>
                        <legend>Fasting Status</legend>
                        <p class="text-xs text-gray-500 mb-2">RCEM 2022: Risk assess; no specific minimum time for low-risk patients.</p>
                        <div><label for="last-food">Time of last food</label><input type="time" id="last-food" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div class="mt-2"><label for="last-fluid">Time of last clear fluid</label><input type="time" id="last-fluid" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                    </fieldset>

                    <!-- ASA Grade -->
                    <fieldset>
                        <legend class="flex items-center">
                            ASA Grade
                            <button type="button" id="asa-guide-button" class="ml-2 bg-blue-100 text-blue-700 w-5 h-5 rounded-full flex items-center justify-center font-bold text-sm no-print">(?)</button>
                        </legend>
                        <div class="mt-2 grid grid-cols-2 sm:grid-cols-5 gap-4">
                            <div class="flex items-center gap-2"><input id="asa-1" name="asa-grade" type="radio" value="I" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="asa-1">I</label></div>
                            <div class="flex items-center gap-2"><input id="asa-2" name="asa-grade" type="radio" value="II" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="asa-2">II</label></div>
                            <div class="flex items-center gap-2"><input id="asa-3" name="asa-grade" type="radio" value="III" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="asa-3">III</label></div>
                            <div class="flex items-center gap-2"><input id="asa-4" name="asa-grade" type="radio" value="IV" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="asa-4">IV</label></div>
                            <div class="flex items-center gap-2"><input id="asa-5" name="asa-grade" type="radio" value="V" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="asa-5">V</label></div>
                        </div>
                        <!-- NEW: ASA Expandable Content -->
                        <div id="asa-guide-content" class="guide-content hidden">
                            <ul class="list-disc list-inside space-y-3">
                                <li><strong>ASA I:</strong> A normal healthy patient.</li>
                                <li><strong>ASA II:</strong> A patient with mild systemic disease (e.g., controlled hypertension, controlled diabetes, mild obesity).</li>
                                <li><strong>ASA III:</strong> A patient with severe systemic disease that limits activity (e.g., stable angina, poorly controlled HTN, morbid obesity, COPD).</li>
                                <li><strong>ASA IV:</strong> A patient with severe systemic disease that is a constant threat to life (e.g., unstable angina, recent MI/CVA, severe sepsis).</li>
                                <li><strong>ASA V:</strong> A moribund patient who is not expected to survive without the operation.</li>
                            </ul>
                            <p class="mt-4 text-sm text-gray-700"><strong>Note:</strong> RCEM guidelines recommend involving senior/anaesthetic staff for ASA III+ patients.</p>
                        </div>
                    </fieldset>

                    <!-- Airway Assessment -->
                    <fieldset>
                        <legend>Airway Assessment</legend>
                        <div class="mt-2 space-y-3">
                            <div class="flex items-center gap-4">
                                <span class="font-bold text-blue-600 w-8 text-lg">L</span>
                                <div class="flex items-center gap-2"><input id="lemon-l-normal" name="lemon-l" type="radio" value="Normal" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lemon-l-normal">Look Normal</label></div>
                                <div class="flex items-center gap-2"><input id="lemon-l-abnormal" name="lemon-l" type="radio" value="Abnormal" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lemon-l-abnormal">Abnormal</label></div>
                                <input type="text" id="lemon-l-specify" class="flex-1 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Specify (e.g., beard, blood)">
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="font-bold text-blue-600 w-8 text-lg">E</span>
                                <div class="flex items-center gap-2"><input id="lemon-e-met" name="lemon-e" type="radio" value="Met" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lemon-e-met">3-3-2 Met</label></div>
                                <div class="flex items-center gap-2"><input id="lemon-e-not-met" name="lemon-e" type="radio" value="Not Met" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lemon-e-not-met">Not Met</label></div>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="font-bold text-blue-600 w-8 text-lg">M</span>
                                <div class="flex items-center gap-2"><input id="lemon-m-1" name="lemon-m" type="radio" value="I" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lemon-m-1">Mallampati I</label></div>
                                <div class="flex items-center gap-2"><input id="lemon-m-2" name="lemon-m" type="radio" value="II" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lemon-m-2">II</label></div>
                                <div class="flex items-center gap-2"><input id="lemon-m-3" name="lemon-m" type="radio" value="III" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lemon-m-3">III</label></div>
                                <div class="flex items-center gap-2"><input id="lemon-m-4" name="lemon-m" type="radio" value="IV" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lemon-m-4">IV</label></div>
                                <button type="button" id="mallampati-guide-button" class="ml-auto bg-blue-100 text-blue-700 w-5 h-5 rounded-full flex items-center justify-center font-bold text-sm no-print">(?)</button>
                            </div>
                            <!-- NEW: Mallampati Expandable Content -->
                            <div id="mallampati-guide-content" class="guide-content hidden text-center">
                                <p class="text-sm text-gray-600 mb-4">Patient sitting upright, mouth open, tongue protruded *without* phonating ("saying ahh").</p>
                                <img src="images/Mallampati.jpg" alt="Mallampati Scores I-IV" class="w-full h-auto rounded-md border" onerror="this.alt='Diagram showing Mallampati classes I, II, III, and IV'">
                                <ul class="list-none text-left space-y-2 mt-4 text-sm">
                                    <li><strong>Class I:</strong> Full visibility of soft palate, uvula, and pillars.</li>
                                    <li><strong>Class II:</strong> Visibility of soft palate and uvula. Pillars hidden.</li>
                                    <li><strong>Class III:</strong> Visibility of soft palate and base of uvula.</li>
                                    <li><strong>Class IV:</strong> Soft palate not visible at all. Only hard palate visible.</li>
                                </ul>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="font-bold text-blue-600 w-8 text-lg">U</span>
                                <div class="flex items-center gap-2"><input id="ulbt-1" name="ulbt" type="radio" value="Class I" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="ulbt-1">ULBT Class I</label></div>
                                <div class="flex items-center gap-2"><input id="ulbt-2" name="ulbt" type="radio" value="Class II" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="ulbt-2">Class II</label></div>
                                <div class="flex items-center gap-2"><input id="ulbt-3" name="ulbt" type="radio" value="Class III" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="ulbt-3">Class III</label></div>
                                <button type="button" id="ulbt-guide-button" class="ml-auto bg-blue-100 text-blue-700 w-5 h-5 rounded-full flex items-center justify-center font-bold text-sm no-print">(?)</button>
                            </div>
                            <!-- NEW: ULBT Expandable Content -->
                            <div id="ulbt-guide-content" class="guide-content hidden text-center">
                                <p class="text-sm text-gray-600 mb-4">Patient attempts to bite their upper lip with their lower teeth.</p>
                                <img src="images/upperlipbitetest.png" alt="Upper Lip Bite Test Classes I-III" class="w-full h-auto rounded-md border" onerror="this.alt='Diagram showing ULBT classes I, II, and III'">
                                <ul class="list-none text-left space-y-2 mt-4 text-sm">
                                    <li><strong>Class I:</strong> Lower incisors can bite the upper lip above the vermilion line (the red part).</li>
                                    <li><strong>Class II:</strong> Lower incisors can bite the upper lip, but *cannot* reach above the vermilion line.</li>
                                    <li><strong>Class III:</strong> Lower incisors cannot bite the upper lip at all.</li>
                                </ul>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="font-bold text-blue-600 w-8 text-lg">O</span>
                                <div class="flex items-center gap-2"><input id="lemon-o-no" name="lemon-o" type="radio" value="No" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lemon-o-no">No Obstruction/OSA</label></div>
                                <div class="flex items-center gap-2"><input id="lemon-o-yes" name="lemon-o" type="radio" value="Yes" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lemon-o-yes">Yes</label></div>
                                <input type="text" id="lemon-o-specify" class="flex-1 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Specify (e.g., OSA)">
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="font-bold text-blue-600 w-8 text-lg">N</span>
                                <div class="flex items-center gap-2"><input id="lemon-n-normal" name="lemon-n" type="radio" value="Normal" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lemon-n-normal">Normal Neck Mobility</label></div>
                                <div class="flex items-center gap-2"><input id="lemon-n-restricted" name="lemon-n" type="radio" value="Restricted" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="lemon-n-restricted">Restricted</label></div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Contraindications -->
                    <fieldset>
                        <legend>Final Contraindications Check</legend>
                        <div class="mt-2 space-y-2">
                            <div class="flex items-start gap-2"><input id="ci-allergy" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="ci-allergy">Known allergy to agents considered.</label></div>
                            <div class="flex items-start gap-2"><input id="ci-hemo" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="ci-hemo">Haemodynamic instability.</label></div>
                            <div class="flex items-start gap-2"><input id="ci-gcs" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="ci-gcs">Compromised airway or reduced GCS.</label></div>
                        </div>
                    </fieldset>
                    
                </div>
            </div> <!-- End Section 2 Box -->

            <!-- 3. Sedation Plan & Preparation Section Box (NEW) -->
            <div class="bg-gray-50 sm:rounded-xl shadow-lg mb-8 overflow-hidden section-box">
                <div class="flex items-center bg-gray-100 border-b border-gray-200 p-4 section-header">
                    <div class="flex-shrink-0 bg-blue-500 rounded-full h-10 w-10 flex items-center justify-center section-header-number">
                        <span class="text-xl font-bold text-white">3</span>
                    </div>
                    <h2 class="text-2xl font-semibold text-blue-800 ml-4">Sedation Plan & Preparation</h2>
                </div>

                <div class="p-6">
                    <!-- This section is now a single column -->
                    
                    <!-- Sedation Plan -->
                    <fieldset>
                        <legend>Sedation Plan</legend>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <div>
                                <label for="plan-target">Target Sedation Level</label>
                                <select id="plan-target" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option>Minimal (Anxiolysis)</option>
                                    <option>Moderate (Conscious)</option>
                                    <option>Deep</option>
                                </select>
                            </div>
                            <div>
                                <label for="plan-agent">Primary Agent(s)</label>
                                <input type="text" id="plan-agent" placeholder="e.g., Propofol, Ketamine" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Equipment Check -->
                    <fieldset>
                        <legend>Equipment Check (SOAP ME)</legend>
                        <div class="mt-2 space-y-2">
                            <div class="flex items-start gap-2"><input id="soap-s" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="soap-s"><strong>S</strong>uction: Working, Yankauer available.</label></div>
                            <div class="flex items-start gap-2"><input id="soap-o" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="soap-o"><strong>O</strong>xygen: Source, nasal cannula, BVM with PEEP.</label></div>
                            <div class="flex items-start gap-2"><input id="soap-a" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="soap-a"><strong>A</strong>irway: OPA, NPA, LMA, C-MAC/DL.</label></div>
                            
                            <!-- Pharmacology Sub-Fieldset -->
                            <fieldset class="mt-2 !border-gray-300 rounded-lg p-3">
                                <legend class="text-base font-semibold text-gray-900 px-1"><strong>P</strong>harmacology</legend>
                                <legend class="text-sm font-medium text-gray-700 mt-1">Sedation Agents Chosen:</legend>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="flex items-center gap-2"><input id="agent-propofol" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="agent-propofol">Propofol</label></div>
                                    <div class="flex items-center gap-2"><input id="agent-ketamine" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="agent-ketamine">Ketamine</label></div>
                                    <div class="flex items-center gap-2"><input id="agent-midazolam" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="agent-midazolam">Midazolam</label></div>
                                    <div class="flex items-center gap-2"><input id="agent-opioid" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="agent-opioid">Opioid (e.g., Fentanyl)</label></div>
                                    <div class="flex items-center gap-2"><input id="agent-other" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="agent-other">Other</label></div>
                                </div>
                                <legend class="text-sm font-medium text-gray-700 mt-3">Emergency Drugs Checked & Available:</legend>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="flex items-center gap-2"><input id="em-atropine" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="em-atropine">Atropine</label></div>
                                    <div class="flex items-center gap-2"><input id="em-metaraminol" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="em-metaraminol">Metaraminol</label></div>
                                    <div class="flex items-center gap-2"><input id="em-sux" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="em-sux">Suxamethonium</label></div>
                                    <div class="flex items-center gap-2"><input id="em-adrenaline" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="em-adrenaline">Adrenaline 1:10k</label></div>
                                    <div class="flex items-center gap-2"><input id="em-flumazenil" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="em-flumazenil">Flumazenil</label></div>
                                    <div class="flex items-center gap-2"><input id="em-naloxone" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="em-naloxone">Naloxone</label></div>
                                </div>
                            </fieldset>
                            <div class="flex items-start gap-2 pt-3"><input id="soap-m" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="soap-m"><strong>M</strong>onitoring: AAGBI Standard (see below).</label></div>
                            <div class="flex items-start gap-2"><input id="soap-e" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="soap-e"><strong>E</strong>nvironment: Resus area, IV access (x1-2).</label></div>
                        </div>
                    </fieldset>

                    <!-- Team Brief -->
                    <fieldset>
                        <legend>Team Brief & Final "Time Out"</legend>
                        <div class="mt-2 space-y-2">
                            <div class="flex items-start gap-2"><input id="plan-roles" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="plan-roles">Roles and responsibilities allocated.</label></div>
                            <div class="flex items-start gap-2"><input id="plan-difficult" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="plan-difficult">Difficult airway / failed sedation plan discussed.</label></div>
                        </div>
                        
                        <!-- CRITICAL SAFETY CHECKS BOX -->
                        <div class="critical-safety-box">
                            <div class="flex items-start gap-2">
                                <input id="plan-aagbi" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1"><label for="plan-aagbi" class="font-semibold">AAGBI Standard Monitoring Confirmed</label>
                            </div>
                            <!-- MANDATORY LIST -->
                            <ul class="pl-8 list-disc space-y-1">
                                <li class="font-bold text-red-600 mandatory-monitoring-item">ECG</li>
                                <li class="font-bold text-red-600 mandatory-monitoring-item">NIBP (q3-5m)</li>
                                <li class="font-bold text-red-600 mandatory-monitoring-item">SpO2 (Continuous)</li>
                                <li class="font-bold text-red-600 mandatory-monitoring-item">Waveform Capnography (Continuous)</li>
                                <li class="flex items-center gap-2"><input id="mon-temp" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="mon-temp" class="text-gray-600">Temperature (Optional)</label></li>
                            </ul>
                            <hr class="my-2 border-blue-100">
                            <div class="flex items-start gap-2"><input id="plan-resus-area" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="plan-resus-area" class="font-medium">Sedation performed in designated Resuscitation / Monitored Area.</label></div>
                            <div class="flex items-start gap-2"><input id="plan-all-monitoring" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="plan-all-monitoring" class="font-medium">All monitoring attached, visible, and alarms set.</label></div>
                        </div>
                    </fieldset>
                    
                    <!-- Pre-Sedation Vitals -->
                    <fieldset>
                        <legend>Pre-Sedation Vitals</legend>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <input type="text" id="pre-vital-hr" placeholder="HR" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <input type="text" id="pre-vital-bp" placeholder="BP (e.g., 120/80)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <input type="text" id="pre-vital-spo2" placeholder="SpO2 (%)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <input type="text" id="pre-vital-rr" placeholder="RR" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </fieldset>
                    
                </div>
            </div> <!-- End Section 3 Box -->

            <!-- 4. Intra-Sedation Record Section Box (Renumbered) -->
            <div class="bg-gray-50 sm:rounded-xl shadow-lg mb-8 overflow-hidden section-box page-break">
                <div class="flex items-center bg-gray-100 border-b border-gray-200 p-4 section-header">
                    <div class="flex-shrink-0 bg-blue-500 rounded-full h-10 w-10 flex items-center justify-center section-header-number">
                        <span class="text-xl font-bold text-white">4</span>
                    </div>
                    <div class="flex-grow flex justify-between items-center ml-4">
                        <h2 class="text-2xl font-semibold text-blue-800">Intra-Sedation Record</h2>
                        <button type="button" id="complications-guide-button" class="no-print bg-blue-100 text-blue-700 py-2 px-4 rounded-lg font-semibold text-sm h-10">[?] View Complications Guide</button>
                    </div>
                </div>

                <div class="p-6">
                    <!-- NEW: Complications Expandable Content -->
                    <div id="complications-guide-content" class="guide-content hidden mb-6 complications-list">
                        <h4>Apnoea / Airway Obstruction</h4>
                        <p><strong>Signs:</strong> Loss of EtCO2 waveform, silent chest, desaturation, paradoxical "see-saw" breathing.</p>
                        <ol class="management-steps">
                            <li><strong>Stimulate:</strong> Use a loud voice, then trapezius squeeze.</li>
                            <li><strong>Reposition:</strong> Apply basic airway manoeuvres (Head-tilt/Chin-lift, Jaw Thrust).</li>
                            <li><strong>Airway Adjunct:</strong> Insert Oropharyngeal (OPA) or Nasopharyngeal (NPA) airway.</li>
                            <li><strong>Assist Ventilation:</strong> Use BVM with 100% O2. Stop giving sedative.</li>
                            <li><strong>Be Patient:</strong> Apnoea is often transient. Maintain airway and oxygenate.</li>
                        </ol>

                        <h4>Laryngospasm</h4>
                        <p><strong>Signs:</strong> High-pitched stridor ("crowing") or complete obstruction after stimulation (e.g., secretions) during light sedation.</p>
                        <ol class="management-steps">
                            <li><strong>Call for help.</strong></li>
                            <li><strong>Apply 100% O2</strong> with a tight-fitting mask and positive pressure (BVM).</li>
                            <li><strong>"Larson's Manoeuvre":</strong> Apply firm, sustained pressure at the "laryngospasm notch" (behind the earlobes, anterior to mastoid).</li>
                            <li><strong>Deepen Sedation:</strong> Small bolus of Propofol (e.g., 0.5 mg/kg) can break the spasm.</li>
                            <li><strong>Last Resort:</strong> Suxamethonium (0.5-1 mg/kg IV) and prepare for intubation.</li>
                        </ol>

                        <h4>Hypotension</h4>
                        <p><strong>Signs:</strong> NIBP drops significantly. Common with Propofol (vasodilation) or in hypovolaemic patients.</p>
                        <ol class="management-steps">
                            <li><strong>Give IV Fluid:</strong> 250-500ml crystalloid bolus.</li>
                            <li><strong>Pause Sedation:</strong> Stop further sedative boluses until BP recovers.</li>
                            <li><strong>Check Cause:</strong> Is it just the drug, or is there another reason (e.g., bleeding, anaphylaxis)?</li>
                            <li><strong>Consider Vasopressor:</strong> If refractory, use small boluses of a pressor (e.g., Metaraminol 0.5mg or Adrenaline 1:100,000).</li>
                        </ol>

                        <h4>Emergence Phenomena (Ketamine)</h4>
                        <p><strong>Signs:</strong> Agitation, hallucinations, vivid dreams, distress during recovery.</p>
                        <ol class="management-steps">
                            <li><strong>Prevention:</strong> Co-administer a small dose of Midazolam (1-2mg) or Propofol.</li>
                            <li><strong>Environment:</strong> Recover patient in a quiet, dark, and calm area.</li>
                            <li><strong>Reassurance:</strong> Talk to the patient calmly.</li>
                            <li><strong>Treatment:</strong> If severe, give a small dose of Midazolam (1-2mg IV).</li>
                        </ol>
                        
                        <h4>Aspiration</h4>
                        <p><strong>Signs:</strong> Active vomiting, food/fluid in oropharynx, acute desaturation, wheeze, or cough.</p>
                        <ol class="management-steps">
                            <li><strong>EMERGENCY:</strong> Call for help.</li>
                            <li><strong>Position:</strong> Immediately turn patient to the side (recovery position) and apply head-down tilt (Trendelenburg).</li>
                            <li><strong>Suction:</strong> Aggressively suction the oropharynx with a Yankauer.</li>
                            <li><strong>Airway:</strong> Secure the airway (may require intubation) for pulmonary toilet and to ensure oxygenation.</li>
                            <li><strong>Supportive Care:</strong> Treat with O2, bronchodilators. Antibiotics are *not* routine.</li>
                        </ol>
                    </div>

                    <!-- Event Timer -->
                    <fieldset class="no-print !border-gray-300 !bg-gray-100">
                        <legend class="text-lg font-semibold text-blue-700 px-2">Event Timeline & Timer</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <div>
                                <button type="button" id="sedation-timer-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Start Sedation Timer</button>
                                <div id="timer-display" class="text-center text-3xl font-mono font-bold text-gray-800 mt-3">00:00:00</div>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <button type="button" id="procedure-start-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg w-32">Procedure Start</button>
                                    <span id="procedure-start-output" class="text-sm font-semibold text-gray-700"></span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button type="button" id="procedure-end-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg w-32">Procedure End</button>
                                    <span id="procedure-end-output" class="text-sm font-semibold text-gray-700"></span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button type="button" id="patient-awake-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg w-32">Patient Awake</button>
                                    <span id="patient-awake-output" class="text-sm font-semibold text-gray-700"></span>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Drug Administration -->
                    <fieldset>
                        <legend>Drug Administration</legend>
                        <div class="overflow-x-auto mt-2 rounded-lg border">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time (HH:MM)</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Drug & Route</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dose (mg)</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Administered By</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="drug-table-body">
                                    <tr>
                                        <td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </fieldset>

                    <!-- Monitoring Log -->
                    <fieldset>
                        <legend>Intra-Sedation Monitoring Log (q5 minutes)</legend>
                        
                        <!-- 5-Minute Toast Location -->
                        <div id="obs-toast" class="hidden">
                            <span>&#9200; <strong>5 Minute Alert:</strong> Please record patient observations.</span>
                            <button id="dismiss-toast-button" class="bg-white/60 hover:bg-white text-yellow-800 py-1 px-3 rounded-full text-sm font-semibold">Dismiss</button>
                        </div>

                        <div class="overflow-x-auto mt-2 rounded-lg border">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">HR</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">BP</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">SpO2</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">RR</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">EtCO2</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">O (L/m)</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Score</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="monitoring-log-body">
                                    <!-- 8 rows for data -->
                                    <tr>
                                        <td><input type="text" class="w-20"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-24"></td><td><input type="text" classs="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-20" placeholder="e.g., RSS"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" class="w-20"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-24"></td><td><input type="text" class="w-16"></td><td><input type="text" class...</td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-20"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" class="w-20"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-24"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-20"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" class="w-20"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-24"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-20"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" class="w-20"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-24"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-20"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text" class="w-20"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-24"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-16"></td><td><input type="text" class="w-20"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </fieldset>

                    <!-- Adverse Events -->
                    <fieldset>
                        <legend>Adverse Events & Interventions</legend>
                        <div class="overflow-x-auto mt-2 rounded-lg border">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time (HH:MM)</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event (e.g., Hypotension, Apnoea)</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Intervention</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Outcome</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="adverse-events-body">
                                    <tr>
                                        <td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td>
                                    </tr>
                                    <tr>
                                        <td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </fieldset>

                    <!-- General Notes -->
                    <fieldset>
                        <legend>General Notes / Events</legend>
                        <textarea id="general-notes" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="e.g., Patient comfortable, procedure well-tolerated..."></textarea>
                    </fieldset>
                </div>
            </div> <!-- End Section 4 Box -->

            <!-- 5. Post-Sedation Section Box (Renumbered) -->
            <div class="bg-gray-50 sm:rounded-xl shadow-lg mb-8 overflow-hidden section-box">
                <div class="flex items-center bg-gray-100 border-b border-gray-200 p-4 section-header">
                    <div class="flex-shrink-0 bg-blue-500 rounded-full h-10 w-10 flex items-center justify-center section-header-number">
                        <span class="text-xl font-bold text-white">5</span>
                    </div>
                    <h2 class="text-2xl font-semibold text-blue-800 ml-4">Post-Sedation Recovery & Outcome</h2>
                </div>

                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-12">
                        <div>
                            
                            <!-- Outcome -->
                            <fieldset>
                                <legend>Procedure & Sedation Outcome</legend>
                                <div class="mt-2 space-y-2">
                                    <div class="flex items-center gap-2"><input id="outcome-proc-yes" name="outcome-proc" type="radio" value="Yes" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="outcome-proc-yes">Procedure Successful</label></div>
                                    <div class="flex items-center gap-2"><input id="outcome-proc-no" name="outcome-proc" type="radio" value="No" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="outcome-proc-no">Procedure Unsuccessful</label></div>
                                    <div class="flex items-center gap-2"><input id="outcome-proc-partial" name="outcome-proc" type="radio" value="Partial" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="outcome-proc-partial">Procedure Partially Successful</label></div>
                                    <hr class="my-2 border-gray-200">
                                    <div class="flex items-center gap-2"><input id="outcome-sed-yes" name="outcome-sed" type="radio" value="Yes" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="outcome-sed-yes">Sedation Successful (Amnesia/Comfort)</label></div>
                                    <div class="flex items-center gap-2"><input id="outcome-sed-no" name="outcome-sed" type="radio" value="No" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="outcome-sed-no">Sedation Unsuccessful</label></div>
                                </div>
                            </fieldset>

                            <!-- Recovery -->
                            <fieldset>
                                <legend>Recovery Details</legend>
                                <div class="mt-2 space-y-4">
                                    <div><label for="recovery-location">Recovery Location</label><input type="text" id="recovery-location" value="ED Resus / Monitored Bay" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                                    <div><label for="handover-time">Time of Handover to Recovery</label><input type="time" id="handover-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                                </div>
                            </fieldset>

                            <!-- Sign Off -->
                            <fieldset>
                                <legend>Sedationist Sign Off</legend>
                                <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div><label for="signoff-name">Sedationist Name</label><input type="text" id="signoff-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                                    <div><label for="signoff-gmc">GMC Number</label><input type="text" id="signoff-gmc" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                                    <div class="sm:col-span-2"><label for="signoff-time">Time of Sign-off</label><input type="time" id="signoff-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                                </div>
                            </fieldset>
                        </div>

                        <div>
                            <!-- Discharge Criteria -->
                            <fieldset>
                                <legend>Discharge Criteria Met (from monitored area)</legend>
                                <div class="mt-2 space-y-2">
                                    <div class="flex items-start gap-2"><input id="dc-aao" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="dc-aao">Alert, orientated, returned to baseline GCS.</label></div>
                                    <div class="flex items-start gap-2"><input id="dc-vitals" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="dc-vitals">Vital signs stable for > 30 mins.</label></div>
                                    <div class="flex items-start gap-2"><input id="dc-ambulate" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="dc-ambulate">Able to ambulate (if baseline).</label></div>
                                    <div class="flex items-start gap-2"><input id="dc-pain" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="dc-pain">Pain controlled.</label></div>
                                    <div class="flex items-start gap-2"><input id="dc-nausea" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="dc-nausea">Nausea / Vomiting controlled.</label></div>
                                </div>
                            </fieldset>

                            <!-- Discharge Advice -->
                            <fieldset>
                                <legend>Discharge Advice Given</legend>
                                <div class="mt-2 space-y-2">
                                    <div class="flex items-start gap-2"><input id="advice-escort" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="advice-escort">Responsible adult escort confirmed.</label></div>
                                    <div class="flex items-start gap-2"><input id="advice-drive" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="advice-drive">No driving or operating machinery (24h).</label></div>
                                    <div class="flex items-start gap-2"><input id="advice-decisions" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="advice-decisions">No important decisions (24h).</label></div>
                                    <div class="flex items-start gap-2"><input id="advice-eat" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="advice-eat">Eat and drink lightly.</label></div>
                                    <div class="flex items-start gap-2"><input id="advice-sheet" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="advice-sheet">Written & verbal post-sedation advice sheet given.</label></div>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                </div>
            </div> <!-- End Section 5 Box -->
            
            <!-- Footer Buttons (Print/Clear) -->
            <footer class="mt-12 text-center no-print">
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="print-button" class="w-full sm:w-auto bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-8 rounded-lg transition shadow-lg">
                        Print / Save as PDF
                    </button>
                    <button id="clear-form-button" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg transition shadow-lg">
                        Clear Form
                    </button>
                </div>
            </footer>
        </form>
    </main>
    
    <!-- 6. Always-Visible EPR Log Section (Renumbered) -->
    <section class="max-w-6xl mx-auto my-8 no-print">
        <div class="bg-gray-50 sm:rounded-xl shadow-lg overflow-hidden section-box">
            <div class="flex items-center bg-gray-100 border-b border-gray-200 p-4 section-header">
                <div class="flex-shrink-0 bg-green-600 rounded-full h-10 w-10 flex items-center justify-center section-header-number">
                    <span class="text-xl font-bold text-white">6</span>
                </div>
                <h2 class="text-2xl font-semibold text-green-800 ml-4">EPR Text Log</h2>
            </div>
            
            <div class="p-6">
                <div class="flex flex-col sm:flex-row justify-center gap-4 mb-4">
                     <button id="generate-update-log-button" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition shadow-lg">
                        Generate / Update Log
                    </button>
                    <button id="copy-log-button-bottom" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg transition shadow-lg">
                        Copy to Clipboard
                    </button>
                </div>
                <textarea id="epr-log-output" class="w-full h-96 p-2 border rounded-md font-mono text-xs bg-gray-100" placeholder="Click 'Generate / Update Log' to populate this field..."></textarea>
            </div>
        </div>
    </section>

    <!-- 
    ================================================================
    MODAL HTML REMOVED
    ================================================================
    -->

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // --- Helper Functions ---
            const val = (id) => document.getElementById(id)?.value || '';
            const text = (id) => document.getElementById(id)?.innerText || '';
            const isChecked = (id) => document.getElementById(id)?.checked;
            const getRadio = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value || 'N/A';
            const timeStamp = () => new Date().toLocaleString('en-GB');
            const formatTime = (date) => date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            
            // --- Timer State ---
            let sedationTimerInterval = null;
            let sedationStartTime = null;
            let secondsElapsed = 0;

            // --- Form Buttons ---
            const printButton = document.getElementById('print-button');
            const clearFormButton = document.getElementById('clear-form-button');
            const generateLogButton = document.getElementById('generate-update-log-button');
            const calculateDosesButton = document.getElementById('calculate-doses-button');
            
            // --- EPR Log Elements ---
            const copyLogButton = document.getElementById('copy-log-button-bottom');
            const eprLogOutput = document.getElementById('epr-log-output');
            
            // --- NEW: Expandable Guide Elements ---
            const asaGuideButton = document.getElementById('asa-guide-button');
            const asaGuideContent = document.getElementById('asa-guide-content');
            
            const complicationsGuideButton = document.getElementById('complications-guide-button');
            const complicationsGuideContent = document.getElementById('complications-guide-content');
            
            const mallampatiGuideButton = document.getElementById('mallampati-guide-button');
            const mallampatiGuideContent = document.getElementById('mallampati-guide-content');
            
            const ulbtGuideButton = document.getElementById('ulbt-guide-button');
            const ulbtGuideContent = document.getElementById('ulbt-guide-content');

            // --- Timer/Event Elements ---
            const obsToast = document.getElementById('obs-toast');
            const dismissToastButton = document.getElementById('dismiss-toast-button');
            const sedationTimerButton = document.getElementById('sedation-timer-button');
            const timerDisplay = document.getElementById('timer-display');
            const procStartButton = document.getElementById('procedure-start-button');
            const procStartOutput = document.getElementById('procedure-start-output');
            const procEndButton = document.getElementById('procedure-end-button');
            const procEndOutput = document.getElementById('procedure-end-output');
            const patientAwakeButton = document.getElementById('patient-awake-button');
            const patientAwakeOutput = document.getElementById('patient-awake-output');


            // --- Event Listeners ---

            // Print Button
            if (printButton) {
                printButton.addEventListener('click', () => {
                    document.title = `SedationRecord_${timeStamp()}`;
                    window.print();
                    setTimeout(() => { document.title = 'Procedural Sedation Checklist & Record'; }, 1000);
                });
            }

            // Clear Form Button
            if (clearFormButton) {
                clearFormButton.addEventListener('click', () => {
                    if (confirm("Are you sure you want to clear all fields? This action cannot be undone.")) {
                        document.getElementById('sedation-form').reset();
                        document.getElementById('dose-output').classList.add('hidden');
                        document.getElementById('dose-output').innerHTML = '';
                        // Reset timer
                        stopSedationTimer();
                        timerDisplay.textContent = '00:00:00';
                        secondsElapsed = 0;
                        // Reset timestamp buttons
                        procStartButton.disabled = false;
                        procStartOutput.textContent = '';
                        procEndButton.disabled = false;
                        procEndOutput.textContent = '';
                        patientAwakeButton.disabled = false;
                        patientAwakeOutput.textContent = '';
                        // Clear EPR log
                        eprLogOutput.value = '';
                        // Hide all guides
                        if(asaGuideContent) asaGuideContent.classList.add('hidden');
                        if(mallampatiGuideContent) mallampatiGuideContent.classList.add('hidden');
                        if(ulbtGuideContent) ulbtGuideContent.classList.add('hidden');
                        if(complicationsGuideContent) complicationsGuideContent.classList.add('hidden');
                    }
                });
            }

            // Generate Log Button
            if (generateLogButton) generateLogButton.addEventListener('click', generateEprLog);

            // Dose Calculator Button
            if (calculateDosesButton) calculateDosesButton.addEventListener('click', calculateDoses);
            
            // --- NEW: Expandable Guide Listeners ---
            const toggleGuide = (contentEl) => {
                if(contentEl) contentEl.classList.toggle('hidden');
            };
            
            if (asaGuideButton) asaGuideButton.addEventListener('click', () => toggleGuide(asaGuideContent));
            if (complicationsGuideButton) complicationsGuideButton.addEventListener('click', () => toggleGuide(complicationsGuideContent));
            if (mallampatiGuideButton) mallampatiGuideButton.addEventListener('click', () => toggleGuide(mallampatiGuideContent));
            if (ulbtGuideButton) ulbtGuideButton.addEventListener('click', () => toggleGuide(ulbtGuideContent));

            // Copy Log Button
            if (copyLogButton) {
                copyLogButton.addEventListener('click', () => {
                    if (!eprLogOutput) return;
                    try {
                        eprLogOutput.select();
                        document.execCommand('copy'); // For iframe compatibility
                        copyLogButton.textContent = 'Copied!';
                        copyLogButton.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                        copyLogButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                        setTimeout(() => {
                            copyLogButton.textContent = 'Copy to Clipboard';
                            copyLogButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
                            copyLogButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        alert('Failed to copy. Please select all text and copy manually.');
                    }
                });
            }
            
            // --- Timer & Timestamp Listeners ---
            if (sedationTimerButton) sedationTimerButton.addEventListener('click', handleSedationTimerClick);
            if (dismissToastButton) dismissToastButton.addEventListener('click', () => obsToast.classList.add('hidden'));
            
            const timestampButtons = [
                { btn: procStartButton, out: procStartOutput },
                { btn: procEndButton, out: procEndOutput },
                { btn: patientAwakeButton, out: patientAwakeOutput }
            ];
            
            timestampButtons.forEach(item => {
                if (item.btn) {
                    item.btn.addEventListener('click', () => {
                        const timeStr = formatTime(new Date());
                        item.out.textContent = `Logged at: ${timeStr}`;
                        item.btn.disabled = true;
                    });
                }
            });

            // --- Timer Functions ---
            
            function handleSedationTimerClick() {
                if (sedationTimerInterval) {
                    stopSedationTimer();
                } else {
                    startSedationTimer();
                }
            }
            
            function startSedationTimer() {
                sedationStartTime = new Date();
                sedationTimerButton.textContent = 'End Sedation Timer';
                sedationTimerButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                sedationTimerButton.classList.add('bg-red-600', 'hover:bg-red-700');
                
                sedationTimerInterval = setInterval(() => {
                    secondsElapsed++;
                    // Format as HH:MM:SS
                    const h = Math.floor(secondsElapsed / 3600).toString().padStart(2, '0');
                    const m = Math.floor((secondsElapsed % 3600) / 60).toString().padStart(2, '0');
                    const s = (secondsElapsed % 60).toString().padStart(2, '0');
                    timerDisplay.textContent = `${h}:${m}:${s}`;
                    
                    // 5-minute prompt (300 seconds)
                    if (secondsElapsed % 300 === 0 && secondsElapsed > 0) {
                        obsToast.classList.remove('hidden');
                    }
                }, 1000);
            }
            
            function stopSedationTimer() {
                clearInterval(sedationTimerInterval);
                sedationTimerInterval = null;
                sedationTimerButton.textContent = 'Start Sedation Timer';
                sedationTimerButton.classList.add('bg-green-600', 'hover:bg-green-700');
                sedationTimerButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                obsToast.classList.add('hidden');
            }

            // --- Dose Calculator Function ---
            function calculateDoses() {
                const weight = parseFloat(val('weight'));
                const isFrail = isChecked('frail-elderly');
                const outputDiv = document.getElementById('dose-output');

                if (!weight || weight <= 0) {
                    outputDiv.innerHTML = '<span class="text-red-600 font-bold">Please enter a valid patient weight (kg).</span>';
                    outputDiv.classList.remove('hidden');
                    return;
                }

                let propofol_initial = [0.5, 1.0];
                let propofol_repeat = [0.25, 0.5];
                let midazolam_initial = [0.02, 0.05];
                let midazolam_repeat = [0.01, 0.02];
                
                if (isFrail) {
                    propofol_initial = [0.25, 0.5]; // 50% reduction
                    propofol_repeat = [0.1, 0.25]; // 50% reduction
                    midazolam_initial = [0.01, 0.025]; // 50% reduction
                    midazolam_repeat = [0.005, 0.01]; // 50% reduction
                }

                const ketamine_initial = [0.5, 1.0]; // Lower end for co-induction
                const ketamine_repeat = [0.25, 0.5];
                
                const formatRange = (range, w) => {
                    const low = (range[0] * w).toFixed(1);
                    const high = (range[1] * w).toFixed(1);
                    return `${low} - ${high} mg`;
                };

                let output = `
                    <p class="text-sm">Weight: <strong>${weight} kg</strong> ${isFrail ? '<span class="text-red-600 font-bold">(Frail/Elderly Doses)</span>' : ''}</p>
                    <table class="min-w-full mt-2 text-xs">
                        <thead class="bg-blue-100">
                            <tr>
                                <th class="p-2 text-left">Agent</th>
                                <th class="p-2 text-left">Initial Bolus (mg/kg)</th>
                                <th class="p-2 text-left">Calculated Dose (mg)</th>
                                <th class="p-2 text-left">Repeat Bolus (mg/kg)</th>
                                <th class="p-2 text-left">Calculated Dose (mg)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="p-2 font-bold">Propofol</td>
                                <td class="p-2">${propofol_initial[0].toFixed(2)}-${propofol_initial[1].toFixed(2)}</td>
                                <td class="p-2 font-bold">${formatRange(propofol_initial, weight)}</td>
                                <td class="p-2">${propofol_repeat[0].toFixed(2)}-${propofol_repeat[1].toFixed(2)}</td>
                                <td class="p-2 font-bold">${formatRange(propofol_repeat, weight)}</td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-2 font-bold">Ketamine</td>
                                <td class="p-2">${ketamine_initial[0].toFixed(2)}-${ketamine_initial[1].toFixed(2)}</td>
                                <td class="p-2 font-bold">${formatRange(ketamine_initial, weight)}</td>
                                <td class="p-2">${ketamine_repeat[0].toFixed(2)}-${ketamine_repeat[1].toFixed(2)}</td>
                                <td class="p-2 font-bold">${formatRange(ketamine_repeat, weight)}</td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-2 font-bold">Midazolam</td>
                                <td class="p-2">${midazolam_initial[0].toFixed(3)}-${midazolam_initial[1].toFixed(3)}</td>
                                <td class="p-2 font-bold">${formatRange(midazolam_initial, weight)}</td>
                                <td class="p-2">${midazolam_repeat[0].toFixed(3)}-${midazolam_repeat[1].toFixed(3)}</td>
                                <td class="p-2 font-bold">${formatRange(midazolam_repeat, weight)}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                
                outputDiv.innerHTML = output;
                outputDiv.classList.remove('hidden');
            }

            // --- EPR Log Generation Function ---
            function generateEprLog() {
                let log = `PROCEDURAL SEDATION RECORD - Generated: ${timeStamp()}\n`;
                log += "=================================================\n\n";

                // --- 1. Patient & Procedure ---
                log += "--- 1. PATIENT & PROCEDURE ---\n";
                log += `Age: ${val('age') || 'N/A'} years\n`;
                log += `Weight: ${val('weight') || 'N/A'} kg (${isChecked('weight-estimated') ? 'Estimated' : 'Actual'})\n`;
                log += `Allergies: ${val('allergies') || 'N/A'}\n`;
                log += `Procedure: ${val('procedure') || 'N/A'}\n`;
                log += `Indication: ${val('indication') || 'N/A'}\n`;
                log += `Pre-Sedation Analgesia: ${val('pre-analgesia') || 'None'}\n\n`;

                // --- 2. Pre-Sedation Assessment ---
                log += "--- 2. PRE-SEDATION ASSESSMENT ---\n";
                log += `Sedationist: ${val('sedationist')}\nProcedure Doctor: ${val('procedure-doctor')}\nNurse: ${val('nurse')}\n`;
                log += `ASA Grade: ${getRadio('asa-grade')}\n`;
                log += `Fasting: Last Food @ ${val('last-food') || 'N/A'}, Last Clear Fluid @ ${val('last-fluid') || 'N/A'}\n\n`;

                // Airway
                log += "Airway Assessment:\n";
                log += `  L (Look): ${getRadio('lemon-l')} ${getRadio('lemon-l') === 'Abnormal' ? `(${val('lemon-l-specify')})` : ''}\n`;
                log += `  E (Evaluate 3-3-2): ${getRadio('lemon-e')}\n`;
                log += `  M (Mallampati): ${getRadio('lemon-m')}\n`;
                log += `  ULBT (Upper Lip Bite Test): ${getRadio('ulbt')}\n`;
                log += `  O (Obstruction/OSA): ${getRadio('lemon-o')} ${getRadio('lemon-o') === 'Yes' ? `(${val('lemon-o-specify')})` : ''}\n`;
                log += `  N (Neck Mobility): ${getRadio('lemon-n')}\n\n`;
                
                // Consent
                log += "Consent:\n";
                log += `  Informed consent obtained: ${isChecked('consent-obtained') ? 'Yes' : 'No'}\n`;
                log += "  Risks Discussed:\n";
                if(isChecked('risk-nausea')) log += "    - Nausea/Vomiting\n";
                if(isChecked('risk-bp')) log += "    - Transient BP/Breathing drop\n";
                if(isChecked('risk-emergence')) log += "    - Agitation/Dreams\n";
                if(isChecked('risk-severe-breathing')) log += "    - Significant breathing problems\n";
                if(isChecked('risk-aspiration')) log += "    - Aspiration\n";
                if(isChecked('risk-allergy')) log += "    - Allergic Reaction\n";
                if(isChecked('risk-major')) log += "    - Major Complication (rare)\n";
                log += "\n";
                
                // Contraindications
                log += "Contraindications Check:\n";
                if(isChecked('ci-allergy')) log += "  - Allergy to agents\n";
                if(isChecked('ci-hemo')) log += "  - Haemodynamic instability\n";
                if(isChecked('ci-gcs')) log += "  - Compromised airway/GCS\n";
                log += "\n";

                // --- 3. Sedation Plan & Preparation ---
                log += "--- 3. SEDATION PLAN & PREPARATION ---\n";
                log += "Plan & Vitals:\n";
                log += `  Target Level: ${val('plan-target')}\n`;
                log += `  Primary Agent(s): ${val('plan-agent')}\n`;
                log += "  Pre-Sedation Vitals:\n";
                log += `    HR: ${val('pre-vital-hr')}, BP: ${val('pre-vital-bp')}, SpO2: ${val('pre-vital-spo2')}, RR: ${val('pre-vital-rr')}\n\n`;
                
                // Final Checks
                log += "Final Checks & Pharmacology:\n";
                log += `  AAGBI Monitoring Confirmed: ${isChecked('plan-aagbi') ? 'Yes' : 'No'}\n`;
                log += `  In Resus / Monitored Area: ${isChecked('plan-resus-area') ? 'Yes' : 'No'}\n`;
                log += `  All Monitoring Attached & Alarms Set: ${isChecked('plan-all-monitoring') ? 'Yes' : 'No'}\n\n`;
                
                log += "Pharmacology Checked:\n";
                log += "  Sedation Agents:\n";
                if(isChecked('agent-propofol')) log += "    - Propofol\n";
                if(isChecked('agent-ketamine')) log += "    - Ketamine\n";
                if(isChecked('agent-midazolam')) log += "    - Midazolam\n";
                if(isChecked('agent-opioid')) log += "    - Opioid\n";
                if(isChecked('agent-other')) log += "    - Other\n";
                
                log += "\n  Emergency Drugs Available:\n";
                if(isChecked('em-atropine')) log += "    - Atropine\n";
                if(isChecked('em-metaraminol')) log += "    - Metaraminol\n";
                if(isChecked('em-sux')) log += "    - Suxamethonium\n";
                if(isChecked('em-adrenaline')) log += "    - Adrenaline 1:10k\n";
                if(isChecked('em-flumazenil')) log += "    - Flumazenil\n";
                if(isChecked('em-naloxone')) log += "    - Naloxone\n\n";


                // --- 4. Intra-Sedation ---
                log += "--- 4. INTRA-SEDATION RECORD ---\n";
                
                // Timestamps
                log += "Key Event Times:\n";
                log += `  Procedure Start: ${text('procedure-start-output').replace('Logged at: ', '') || 'N/A'}\n`;
                log += `  Procedure End: ${text('procedure-end-output').replace('Logged at: ', '') || 'N/A'}\n`;
                log += `  Patient Awake: ${text('patient-awake-output').replace('Logged at: ', '') || 'N/A'}\n\n`;
                
                log += "Drug Administration:\n";
                log += "Time\tDrug & Route\tDose (mg)\tAdministered By\n";
                const drugRows = document.getElementById('drug-table-body').rows;
                for (let row of drugRows) {
                    const cells = row.getElementsByTagName('input');
                    if (cells[0].value) { // Only log rows where a time is entered
                        log += `${cells[0].value}\t${cells[1].value}\t${cells[2].value}\t${cells[3].value}\n`;
                    }
                }

                log += "\nMonitoring Log (q5min):\n";
                log += "Time\tHR\tBP\tSpO2\tRR\tEtCO2\tO\tScore\n";
                const monRows = document.getElementById('monitoring-log-body').rows;
                for (let row of monRows) {
                    const cells = row.getElementsByTagName('input');
                    if (cells[0].value) { // Only log rows where a time is entered
                        log += `${cells[0].value}\t${cells[1].value}\t${cells[2].value}\t${cells[3].value}\t${cells[4].value}\t${cells[5].value}\t${cells[6].value}\t${cells[7].value}\n`;
                    }
                }

                log += "\nAdverse Events & Interventions:\n";
                log += "Time\tEvent\tIntervention\tOutcome\n";
                const eventRows = document.getElementById('adverse-events-body').rows;
                for (let row of eventRows) {
                    const cells = row.getElementsByTagName('input');
                    if (cells[0].value) { // Only log rows where a time is entered
                        log += `${cells[0].value}\t${cells[1].value}\t${cells[2].value}\t${cells[3].value}\n`;
                    }
                }

                // General Notes
                const generalNotes = val('general-notes');
                if (generalNotes) {
                    log += "\nGeneral Notes / Events:\n";
                    log += `${generalNotes}\n`;
                }


                // --- 5. Post-Sedation ---
                log += "\n--- 5. POST-SEDATION & OUTCOME ---\n";
                log += `Procedure Outcome: ${getRadio('outcome-proc')}\n`;
                log += `Sedation Outcome: ${getRadio('outcome-sed')}\n\n`;
                
                log += "Discharge Criteria Met:\n";
                if(isChecked('dc-aao')) log += "  - Alert & Orientated\n";
                if(isChecked('dc-vitals')) log += "  - Vitals Stable\n";
                if(isChecked('dc-ambulate')) log += "  - Ambulating (baseline)\n";
                if(isChecked('dc-pain')) log += "  - Pain Controlled\n";
                if(isChecked('dc-nausea')) log += "  - Nausea/Vomiting Controlled\n\n";

                log += "Discharge Advice Given:\n";
                if(isChecked('advice-escort')) log += "  - Responsible Adult Escort\n";
                if(isChecked('advice-drive')) log += "  - No driving/machinery (24h)\n";
                if(isChecked('advice-decisions')) log += "  - No important decisions (24h)\n";
                if(isChecked('advice-eat')) log += "  - Eat/drink lightly\n";
                if(isChecked('advice-sheet')) log += "  - Written & verbal advice given\n\n";

                log += "--- SIGN OFF ---\n";
                log += `Handover to Recovery @ ${val('handover-time') || 'N/A'}\n`;
                log += `Sedationist: ${val('signoff-name') || 'N/A'} (GMC: ${val('signoff-gmc') || 'N/A'})\n`;
                log += `Sign-off Time: ${val('signoff-time') || 'N/A'}\n`;

                // Set output
                eprLogOutput.value = log;
            }
            
            // Override default confirm/alert
            const originalConfirm = window.confirm;
            window.confirm = (message) => {
                try {
                    return originalConfirm(message);
                } catch (e) {
                    console.warn("Browser 'confirm' was blocked. Defaulting to 'true'.", e);
                    return true;
                }
            };
            
            const originalAlert = window.alert;
            window.alert = (message) => {
                try {
                    originalAlert(message);
                } catch (e)
                {
                    console.warn("Browser 'alert' was blocked. Message:", message);
                }
            };

        });
    </script>

</body>
</html>



