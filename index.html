<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sedation & Agitation Management Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b' } 
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORE STYLES --- */
        body { font-family: 'Inter', sans-serif; }
        html { scroll-behavior: smooth; }
        
        /* Transitions */
        .transition-height { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Inputs */
        input, textarea, select { outline: none; transition: all 0.2s; }
        input:focus, textarea:focus, select:focus { ring: 2px; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); border-color: #2563eb; }
        
        .dark input, .dark textarea, .dark select { 
            background-color: #334155; 
            border-color: #475569; 
            color: #f8fafc; 
        }
        .dark input::placeholder { color: #94a3b8; }

        /* Touch Targets (Fat Finger Optimization) */
        .touch-group-label {
            @apply flex items-center justify-center p-3 border-2 rounded-lg cursor-pointer transition-all select-none font-bold text-sm text-center bg-white text-slate-600 border-slate-200 hover:bg-slate-50;
        }
        .touch-group-label.dark-mode-target {
            @apply dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700;
        }
        
        /* Active States for Button Groups */
        .peer:checked + .touch-group-label {
            @apply bg-blue-600 text-white border-blue-700 shadow-md transform scale-[1.02];
        }
        .peer:checked + .touch-group-label-red {
            @apply bg-red-600 text-white border-red-700 shadow-md transform scale-[1.02];
        }
        .peer:checked + .touch-group-label-amber {
            @apply bg-amber-500 text-white border-amber-600 shadow-md transform scale-[1.02];
        }

        /* Checkbox Custom Style */
        .chk-label {
            @apply flex items-center gap-2 p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer text-xs font-bold text-slate-700 dark:text-slate-300 transition;
        }
        .chk-input {
            @apply w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 dark:bg-slate-600 dark:border-slate-500;
        }

        /* Buttons */
        .std-btn { 
            @apply transition-all border border-slate-300 bg-slate-50 text-slate-700 rounded-lg font-bold px-4 py-2 text-xs inline-flex items-center justify-center hover:bg-slate-200 active:translate-y-px;
        }
        .dark .std-btn {
            @apply bg-slate-700 border-slate-600 text-slate-200 hover:bg-slate-600;
        }

        .drug-btn {
            @apply bg-white border border-slate-300 text-slate-600 font-bold text-xs px-3 py-3 rounded-lg shadow-sm transition-all hover:bg-slate-50 active:scale-95 flex-grow text-center min-w-[80px];
        }
        .dark .drug-btn {
            @apply bg-slate-800 border-slate-600 text-slate-300 hover:bg-slate-700;
        }

        /* Rich Text Output */
        .rich-output {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.85rem;
            line-height: 1.4;
            color: #334155;
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 1rem;
            min-height: 24rem;
            overflow-y: auto;
            white-space: pre-wrap; 
        }
        .dark .rich-output {
            background-color: #1e293b;
            color: #cbd5e1;
            border-color: #475569;
        }
        .rich-output strong { font-weight: 800; }
        .dark .rich-output strong { color: white; }

        /* Agitated Stripes */
        .agitated-warning {
            background: repeating-linear-gradient(45deg, #fffbeb, #fffbeb 10px, #fef3c7 10px, #fef3c7 20px);
        }
        .dark .agitated-warning {
            background: repeating-linear-gradient(45deg, #450a0a, #450a0a 10px, #7f1d1d 10px, #7f1d1d 20px);
        }

        /* Print Hiding */
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; }
            .section-card { break-inside: avoid; border: 1px solid #ccc !important; box-shadow: none !important; }
            .dark { color-scheme: light; } 
            .dark .section-card { background: white !important; color: black !important; }
            #sticky-footer { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 dark:bg-slate-900 dark:text-slate-100 antialiased pb-24 transition-colors duration-200">

    <header class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-50 border-b border-slate-300 dark:border-slate-700 no-print">
        <div class="container mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://iili.io/KGQOvkl.md.png" alt="Logo" class="h-10 md:h-12 w-auto object-contain" onerror="this.style.display='none'">
                <div>
                    <h1 class="text-lg md:text-xl font-black leading-tight">Sedation Record</h1>
                    <p class="text-[10px] text-green-600 font-bold flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Auto-save enabled
                    </p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button id="dark-mode-toggle" class="p-2 rounded-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition" title="Toggle Dark Mode">
                    <span class="dark:hidden">üåô</span>
                    <span class="hidden dark:inline">‚òÄÔ∏è</span>
                </button>

                <button id="header-print-letter-btn" class="hidden sm:inline-flex px-3 py-2 bg-purple-600 text-white text-xs font-bold rounded hover:bg-purple-700 transition">
                    LETTER
                </button>
                <button id="header-print-btn" class="px-3 py-2 bg-slate-800 dark:bg-slate-700 text-white text-xs font-bold rounded hover:bg-slate-700 dark:hover:bg-slate-600 transition">
                    PRINT
                </button>
                <button id="reset-btn" class="px-3 py-2 bg-red-100 text-red-700 text-xs font-bold rounded hover:bg-red-200 transition">
                    RESET
                </button>
            </div>
        </div>
        
        <div id="tabs-container" class="container mx-auto px-4 flex gap-4 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800">
            <button id="btn-tab-procedural" class="flex-1 py-3 text-sm font-black text-center border-b-4 border-blue-600 text-blue-800 dark:text-blue-400">Standard Sedation</button>
            <button id="btn-tab-agitated" class="flex-1 py-3 text-sm font-black text-center border-b-4 border-transparent text-slate-500 hover:text-red-600 dark:text-slate-400">üö® Agitated Patient</button>
        </div>
    </header>

    <main id="main-app-container" class="container mx-auto px-4 py-4 max-w-7xl"> 
        
        <div id="tab-procedural" class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <div class="lg:col-span-8 flex flex-col gap-4">
                <form id="sedation-form" onsubmit="return false;">
                    <div class="flex flex-col gap-4">

                        <div id="section-1" class="section-card bg-white dark:bg-slate-800 border-l-[6px] border-l-blue-600 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4 transition-all">
                            <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="toggleSection('section-1-content')">
                                <h2 class="text-lg font-black text-blue-800 dark:text-blue-400">1. Patient & Procedure</h2>
                                <span class="text-xs text-slate-400 toggle-icon">‚ñº</span>
                            </div>
                            
                            <div id="section-1-content" class="transition-height overflow-hidden">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-2">
                                    <div class="md:col-span-2">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Age</label>
                                        <input type="number" id="age" placeholder="Yr" class="p-2 border rounded-lg w-full font-bold dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Weight (kg) <span class="text-red-500">*</span></label>
                                        <div class="flex gap-2">
                                            <input type="number" id="weight" placeholder="kg" class="p-2 border rounded-lg w-full font-bold dark:bg-slate-700 dark:border-slate-600">
                                            <label class="cursor-pointer relative min-w-[60px]">
                                                <input type="checkbox" id="weight-estimated" class="peer sr-only">
                                                <div class="h-full flex items-center justify-center border rounded-lg bg-slate-50 text-slate-500 font-bold text-[10px] uppercase peer-checked:bg-blue-600 peer-checked:text-white dark:bg-slate-700 dark:border-slate-600 transition">Est</div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Allergies</label>
                                        <div id="allergy-container" class="transition-colors rounded-lg">
                                            <input type="text" id="allergies" placeholder="Reaction details..." class="w-full p-2 border rounded-lg font-bold text-red-700 dark:text-red-400 border-slate-300 dark:bg-slate-700 dark:border-slate-600">
                                        </div>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Procedure</label>
                                        <input type="text" id="procedure" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Indication</label>
                                        <input type="text" id="indication" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Pre-Sedation Analgesia</label>
                                        <input type="text" id="pre-analgesia" placeholder="e.g. IV Morphine" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                    
                                    <div class="md:col-span-4 grid grid-cols-2 gap-4 border-t pt-2 dark:border-slate-600 mt-2">
                                        <div><label class="text-[10px] font-bold uppercase">Sedationist</label><input type="text" id="sedationist" class="w-full p-1 border rounded text-xs dark:bg-slate-700 dark:border-slate-600"></div>
                                        <div><label class="text-[10px] font-bold uppercase">Grade</label><input type="text" id="sedationist-grade" class="w-full p-1 border rounded text-xs dark:bg-slate-700 dark:border-slate-600"></div>
                                        <div><label class="text-[10px] font-bold uppercase">Proc. Doctor</label><input type="text" id="procedure-doctor" class="w-full p-1 border rounded text-xs dark:bg-slate-700 dark:border-slate-600"></div>
                                        <div><label class="text-[10px] font-bold uppercase">Nurse</label><input type="text" id="nurse" class="w-full p-1 border rounded text-xs dark:bg-slate-700 dark:border-slate-600"></div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 p-3 bg-blue-50 dark:bg-slate-700/50 rounded-lg border border-blue-100 dark:border-slate-600">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs font-black text-blue-900 dark:text-blue-300">Standard Dose Guide</span>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="frail-elderly" class="peer sr-only">
                                            <div class="px-2 py-1 bg-white border rounded text-[10px] font-bold text-slate-500 peer-checked:bg-blue-600 peer-checked:text-white transition">Frail / >65</div>
                                        </label>
                                    </div>
                                    <button type="button" id="calculate-doses-button" class="w-full py-2 bg-white dark:bg-slate-600 border border-blue-200 dark:border-slate-500 rounded font-bold text-blue-700 dark:text-blue-200 shadow-sm text-xs">
                                        CALCULATE RANGES
                                    </button>
                                    <div id="dose-output" class="hidden mt-2 pt-2 border-t border-blue-200 dark:border-slate-600 text-sm font-mono text-slate-800 dark:text-slate-200"></div>
                                </div>
                            </div>
                        </div>

                        <div id="section-2" class="section-card bg-white dark:bg-slate-800 border-l-[6px] border-l-orange-500 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4">
                            <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="toggleSection('section-2-content')">
                                <h2 class="text-lg font-black text-orange-800 dark:text-orange-400">2. Assessment & Risks</h2>
                                <span class="text-xs text-slate-400 toggle-icon">‚ñº</span>
                            </div>

                            <div id="section-2-content" class="transition-height overflow-hidden">
                                <div class="mb-4">
                                    <label class="text-xs font-bold text-slate-500 uppercase mb-1">Has Capacity?</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="cursor-pointer">
                                            <input type="radio" name="capacity" value="Yes" checked class="peer sr-only">
                                            <div class="touch-group-label dark-mode-target">YES</div>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="capacity" value="No" class="peer sr-only">
                                            <div class="touch-group-label text-red-700 dark-mode-target">NO</div>
                                        </label>
                                    </div>
                                    <div id="capacity-options" class="hidden mt-2"><input type="radio" name="consent-type" value="Best Interests" checked></div>
                                </div>

                                <div id="airway-card" class="p-3 border rounded-lg mb-4 bg-slate-50 dark:bg-slate-700/30 dark:border-slate-600 transition-colors duration-300">
                                    <label class="text-xs font-black text-slate-600 dark:text-slate-400 uppercase border-b border-slate-300 dark:border-slate-600 pb-1 mb-2 block">Airway Assessment</label>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <span class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Mallampati</span>
                                            <div class="flex items-center gap-2 mb-2">
                                                <img src="https://iili.io/KGQOvkl.md.png" alt="Mallampati" class="h-10 w-auto rounded border" onerror="this.style.display='none'"> 
                                                <div class="flex-1 flex gap-1">
                                                    <label class="flex-1 cursor-pointer"><input type="radio" name="airway-mallampati" value="I" class="peer sr-only"><div class="touch-group-label dark-mode-target py-2">I</div></label>
                                                    <label class="flex-1 cursor-pointer"><input type="radio" name="airway-mallampati" value="II" class="peer sr-only"><div class="touch-group-label dark-mode-target py-2">II</div></label>
                                                    <label class="flex-1 cursor-pointer"><input type="radio" name="airway-mallampati" value="III" class="peer sr-only"><div class="touch-group-label-amber dark-mode-target py-2">III</div></label>
                                                    <label class="flex-1 cursor-pointer"><input type="radio" name="airway-mallampati" value="IV" class="peer sr-only"><div class="touch-group-label-red dark-mode-target py-2">IV</div></label>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <span class="text-[10px] font-bold text-slate-500 uppercase block mb-1">ULBT (Upper Lip Bite)</span>
                                            <div class="flex items-center gap-2 mb-2">
                                                <img src="https://iili.io/2d8S5X.png" alt="ULBT" class="h-10 w-auto rounded border" onerror="this.style.display='none'">
                                                <div class="flex-1 flex gap-1">
                                                     <label class="flex-1 cursor-pointer"><input type="radio" name="airway-ulbt" value="1" class="peer sr-only"><div class="touch-group-label dark-mode-target py-2">1</div></label>
                                                     <label class="flex-1 cursor-pointer"><input type="radio" name="airway-ulbt" value="2" class="peer sr-only"><div class="touch-group-label dark-mode-target py-2">2</div></label>
                                                     <label class="flex-1 cursor-pointer"><input type="radio" name="airway-ulbt" value="3" class="peer sr-only"><div class="touch-group-label-red dark-mode-target py-2">3</div></label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <span class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Difficult Airway Predictors</span>
                                        <div class="flex flex-wrap gap-3">
                                            <label class="chk-label"><input type="checkbox" id="airway-mouth" class="chk-input"> Mouth &lt;3cm</label>
                                            <label class="chk-label"><input type="checkbox" id="airway-tmd" class="chk-input"> Thyromental &lt;6cm</label>
                                            <label class="chk-label"><input type="checkbox" id="airway-neck" class="chk-input"> Neck Immobile</label>
                                            <label class="chk-label"><input type="checkbox" id="airway-bmi" class="chk-input"> BMI &gt;35</label>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2 pt-2 border-t border-slate-200 dark:border-slate-600">
                                         <div class="flex justify-between items-center mb-1">
                                             <span class="text-[10px] font-bold text-slate-500 uppercase">ASA Grade</span>
                                             <button type="button" onclick="document.getElementById('asa-help').classList.toggle('hidden')" class="text-[10px] bg-slate-200 dark:bg-slate-600 px-2 rounded">?</button>
                                         </div>
                                         <div id="asa-help" class="hidden text-xs text-slate-500 mb-2 italic">I:Healthy II:Mild III:Severe IV:Threat to Life</div>
                                         <div class="flex gap-1">
                                                <label class="flex-1 cursor-pointer"><input type="radio" name="asa-grade" value="I" class="peer sr-only"><div class="touch-group-label dark-mode-target py-2">I</div></label>
                                                <label class="flex-1 cursor-pointer"><input type="radio" name="asa-grade" value="II" class="peer sr-only"><div class="touch-group-label dark-mode-target py-2">II</div></label>
                                                <label class="flex-1 cursor-pointer"><input type="radio" name="asa-grade" value="III" class="peer sr-only"><div class="touch-group-label-amber dark-mode-target py-2">III</div></label>
                                                <label class="flex-1 cursor-pointer"><input type="radio" name="asa-grade" value="IV" class="peer sr-only"><div class="touch-group-label-red dark-mode-target py-2">IV</div></label>
                                         </div>
                                    </div>
                                </div>

                                <div class="mb-4 bg-slate-50 dark:bg-slate-700/30 p-3 rounded-lg border border-slate-200 dark:border-slate-600">
                                    <label class="text-xs font-black text-slate-600 dark:text-slate-400 uppercase border-b border-slate-300 dark:border-slate-600 pb-1 mb-2 block">Risk Discussion</label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <span class="text-[10px] font-bold text-slate-500 uppercase">Common (>1:100)</span>
                                            <div class="space-y-1">
                                                <label class="chk-label"><input type="checkbox" id="risk-nausea" class="chk-input"> Nausea/Vomiting</label>
                                                <label class="chk-label"><input type="checkbox" id="risk-drowsy" class="chk-input"> Drowsiness</label>
                                                <label class="chk-label"><input type="checkbox" id="risk-hypotension" class="chk-input"> Hypotension</label>
                                                <label class="chk-label"><input type="checkbox" id="risk-resp-depress" class="chk-input"> Hypoxia/Resp. Dep</label>
                                            </div>
                                        </div>
                                        <div>
                                            <span class="text-[10px] font-bold text-red-500 uppercase">Rare (~1:1000)</span>
                                            <div class="space-y-1">
                                                <label class="chk-label text-red-700"><input type="checkbox" id="risk-laryngospasm" class="chk-input"> Laryngospasm</label>
                                                <label class="chk-label text-red-700"><input type="checkbox" id="risk-aspiration" class="chk-input"> Aspiration</label>
                                                <label class="chk-label text-red-700"><input type="checkbox" id="risk-allergy" class="chk-input"> Anaphylaxis</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4 mb-2">
                                    <div>
                                        <label class="text-[10px] uppercase font-bold text-slate-500">Last Food</label>
                                        <div class="flex gap-1">
                                            <input type="time" id="last-food" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                            <button type="button" onclick="setNow('last-food')" class="bg-slate-200 dark:bg-slate-600 text-xs font-bold px-2 rounded hover:bg-slate-300">NOW</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-[10px] uppercase font-bold text-slate-500">Last Fluid</label>
                                        <div class="flex gap-1">
                                            <input type="time" id="last-fluid" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                            <button type="button" onclick="setNow('last-fluid')" class="bg-slate-200 dark:bg-slate-600 text-xs font-bold px-2 rounded hover:bg-slate-300">NOW</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="section-3" class="section-card bg-white dark:bg-slate-800 border-l-[6px] border-l-green-500 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4">
                            <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="toggleSection('section-3-content')">
                                <h2 class="text-lg font-black text-green-800 dark:text-green-400">3. Plan & Safety</h2>
                                <span class="text-xs text-slate-400 toggle-icon">‚ñº</span>
                            </div>
                            
                            <div id="section-3-content" class="transition-height overflow-hidden">
                                <label class="text-xs font-bold text-slate-500 uppercase mb-1">SOAP-ME Checklist</label>
                                <div class="grid grid-cols-5 gap-1 mb-4">
                                    <label class="cursor-pointer"><input type="checkbox" id="soap-s" class="peer sr-only"><div class="touch-group-label dark-mode-target text-xs p-2">SUCT</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" id="soap-o" class="peer sr-only"><div class="touch-group-label dark-mode-target text-xs p-2">OXYG</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" id="soap-a" class="peer sr-only"><div class="touch-group-label dark-mode-target text-xs p-2">AIRW</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" id="soap-m" class="peer sr-only"><div class="touch-group-label dark-mode-target text-xs p-2">MONI</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" id="soap-e" class="peer sr-only"><div class="touch-group-label dark-mode-target text-xs p-2">ENV</div></label>
                                </div>
                                
                                <div id="timeout-container" class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 p-3 rounded-lg">
                                    <label class="text-xs font-black text-yellow-800 dark:text-yellow-500 uppercase mb-2 block">üõë Safety Time Out</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="cursor-pointer"><input type="checkbox" id="to-identity" class="peer sr-only"><div class="touch-group-label dark-mode-target">ID</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" id="to-role" class="peer sr-only"><div class="touch-group-label dark-mode-target">Roles</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" id="to-site" class="peer sr-only"><div class="touch-group-label dark-mode-target">Site</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" id="to-monitoring" class="peer sr-only"><div class="touch-group-label dark-mode-target">Monit</div></label>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <label class="text-xs font-bold text-slate-500 uppercase">Pre-Vitals</label>
                                    <div class="grid grid-cols-4 gap-2">
                                        <input type="text" id="pre-vital-hr" placeholder="HR" class="p-2 border rounded text-center dark:bg-slate-700 dark:border-slate-600">
                                        <input type="text" id="pre-vital-bp" placeholder="BP" class="p-2 border rounded text-center dark:bg-slate-700 dark:border-slate-600">
                                        <input type="text" id="pre-vital-spo2" placeholder="SpO2" class="p-2 border rounded text-center dark:bg-slate-700 dark:border-slate-600">
                                        <input type="text" id="pre-vital-rr" placeholder="RR" class="p-2 border rounded text-center dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="section-4" class="bg-slate-800 dark:bg-black rounded-xl p-4 text-white shadow-lg border-2 border-slate-900 page-break">
                            
                            <div class="flex flex-col items-center justify-center gap-4 mb-4">
                                <div class="w-full flex justify-between items-center mb-2">
                                    <span class="text-xs uppercase font-bold text-slate-400">Sedation Timer</span>
                                    <button type="button" onclick="document.getElementById('complications-guide').classList.toggle('hidden')" class="text-xs bg-slate-700 px-2 py-1 rounded hover:bg-slate-600">Emergency Guide</button>
                                </div>
                                
                                <div id="complications-guide" class="hidden w-full text-xs text-yellow-300 bg-slate-700 p-2 rounded mb-2 border border-yellow-600">
                                    <strong>TROOPS/SIVA Quick Ref:</strong><br>
                                    ‚Ä¢ Laryngospasm: 100% O‚ÇÇ / Jaw Thrust / Succinylcholine<br>
                                    ‚Ä¢ Hypotension: Fluids / Metaraminol<br>
                                    ‚Ä¢ Apnoea: BVM / Airway adjuncts
                                </div>

                                <div id="timer-display" class="text-6xl md:text-7xl font-mono font-black tracking-widest text-white tabular-nums">00:00</div>
                                <button type="button" id="sedation-timer-button" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-black text-xl rounded-lg shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all">
                                    START SEDATION TIMER
                                </button>
                            </div>

                            <div class="grid grid-cols-3 gap-2 border-t border-slate-700 pt-4">
                                <div class="text-center">
                                    <button type="button" id="procedure-start-button" class="w-full py-2 bg-slate-700 rounded text-slate-300 font-bold text-xs border border-slate-600 hover:bg-slate-600">PROC START</button>
                                    <span id="procedure-start-output" class="text-xs font-mono text-green-400 block h-4 mt-1"></span>
                                </div>
                                <div class="text-center">
                                    <button type="button" id="procedure-end-button" class="w-full py-2 bg-slate-700 rounded text-slate-300 font-bold text-xs border border-slate-600 hover:bg-slate-600">PROC END</button>
                                    <span id="procedure-end-output" class="text-xs font-mono text-green-400 block h-4 mt-1"></span>
                                </div>
                                <div class="text-center">
                                    <button type="button" id="patient-awake-button" class="w-full py-2 bg-slate-700 rounded text-slate-300 font-bold text-xs border border-slate-600 hover:bg-slate-600">AWAKE</button>
                                    <span id="patient-awake-output" class="text-xs font-mono text-green-400 block h-4 mt-1"></span>
                                </div>
                            </div>
                        </div>

                        <div class="section-card bg-white dark:bg-slate-800 border-l-[6px] border-l-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4">
                            
                            <div class="mb-6">
                                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Drugs Given</label>
                                <div id="drug-table-container" class="space-y-2"></div> 
                                <div id="empty-drugs-msg" class="text-sm text-slate-400 italic text-center py-2">No drugs recorded yet</div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Observations (q5min)</label>
                                <div id="obs-table-container" class="space-y-2"></div>
                            </div>
                            
                            <div class="mt-4">
                                <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Notes</label>
                                <textarea id="general-notes" rows="3" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600"></textarea>
                            </div>
                        </div>

                        <div id="section-5" class="section-card bg-white dark:bg-slate-800 border-l-[6px] border-l-purple-600 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4">
                            <h2 class="text-lg font-black text-purple-800 dark:text-purple-400 mb-4">5. Discharge & Checklist</h2>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <label class="cursor-pointer">
                                    <input type="radio" name="outcome-proc" value="Successful" class="peer sr-only">
                                    <div class="touch-group-label dark-mode-target py-4">SUCCESSFUL</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="outcome-proc" value="Unsuccessful" class="peer sr-only">
                                    <div class="touch-group-label text-red-700 dark-mode-target py-4">FAILED</div>
                                </label>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4 p-3 bg-purple-50 dark:bg-purple-900/20 rounded">
                                <label class="chk-label"><input type="checkbox" id="dc-vitals" class="chk-input"> Baseline Vitals</label>
                                <label class="chk-label"><input type="checkbox" id="dc-aao" class="chk-input"> Alert & Orientated</label>
                                <label class="chk-label"><input type="checkbox" id="dc-oral" class="chk-input"> Tolerating Fluids</label>
                                <label class="chk-label"><input type="checkbox" id="dc-pain" class="chk-input"> Pain Managed</label>
                                <label class="chk-label"><input type="checkbox" id="dc-home" class="chk-input"> Carer / Home</label>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label class="text-[10px] uppercase font-bold">Sign-off Name</label><input type="text" id="signoff-name" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600"></div>
                                <div><label class="text-[10px] uppercase font-bold">Time</label>
                                    <div class="flex gap-1">
                                        <input type="time" id="signoff-time" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                                        <button type="button" onclick="setNow('signoff-time')" class="bg-slate-200 dark:bg-slate-600 text-xs font-bold px-2 rounded">NOW</button>
                                    </div>
                                </div>
                            </div>

                            <button type="button" id="create-discharge-letter-btn" class="w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-md mb-8">
                                üìù GENERATE DISCHARGE LETTER
                            </button>
                        </div>
                    </div>
                </form>
            </div> 

            <div class="lg:col-span-4 relative no-print">
                <div class="sticky top-24 h-fit space-y-4">
                    <div id="epr-log-container" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-lg border border-slate-300 dark:border-slate-700">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wide">EPR Quick Log</h2>
                            <button type="button" id="copy-log-button" class="px-3 py-1 text-xs font-bold bg-blue-600 text-white rounded hover:bg-blue-700 transition shadow-sm">
                                Copy Rich Text
                            </button>
                        </div>
                        <div id="epr-log-output" class="rich-output focus:ring-2 ring-blue-500 ring-offset-2 text-xs" contenteditable="true">
                            </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="tab-agitated" class="hidden">
            <div class="agitated-warning border-l-[10px] border-l-red-600 shadow-lg rounded-r-xl p-6 mb-6">
                <h1 class="text-2xl md:text-4xl font-black text-red-900 uppercase leading-none">Agitated Patient Protocol</h1>
                <p class="text-red-800 font-bold mt-2 text-sm uppercase">Immediate Threat to Safety</p>
            </div>

            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow border border-slate-200 dark:border-slate-700 mb-6">
                <label class="block text-slate-500 font-bold text-xs uppercase mb-1">Estimated Weight (kg)</label>
                <div class="flex gap-2 mb-4">
                    <input type="number" id="agitated-weight" placeholder="kg" class="text-3xl font-black w-full p-3 border-2 border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-red-500">
                    <button id="calc-agitated-btn" class="bg-red-600 text-white font-black px-6 rounded-lg shadow-lg active:scale-95 transition">CALC</button>
                </div>

                <div id="agitated-output" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-red-50 dark:bg-red-900/30 border-2 border-red-500 rounded-xl p-4 text-center">
                        <span class="block text-xs font-black text-red-600 dark:text-red-400 uppercase tracking-widest mb-2">IM Ketamine (4mg/kg)</span>
                        <span id="val-ket-im" class="block text-6xl md:text-7xl font-black text-slate-900 dark:text-white leading-none tracking-tighter my-2">--</span>
                        <span class="text-sm font-bold text-slate-500 dark:text-slate-400">milligrams</span>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/30 border-2 border-orange-400 rounded-xl p-4 text-center opacity-75">
                         <span class="block text-xs font-black text-orange-600 dark:text-orange-400 uppercase tracking-widest mb-2">IV Ketamine (1mg/kg)</span>
                         <span id="val-ket-iv" class="block text-5xl font-black text-slate-900 dark:text-white leading-none tracking-tighter my-2">--</span>
                         <span class="text-sm font-bold text-slate-500 dark:text-slate-400">milligrams</span>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-3 border-b pb-2">Post-Sedation Checklist</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <label class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600 cursor-pointer">
                        <input type="checkbox" class="w-6 h-6 text-blue-600 rounded">
                        <span class="font-bold text-sm">Full Monitoring Applied</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600 cursor-pointer">
                        <input type="checkbox" class="w-6 h-6 text-blue-600 rounded">
                        <span class="font-bold text-sm">Transfer to Resus</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600 cursor-pointer">
                        <input type="checkbox" class="w-6 h-6 text-blue-600 rounded">
                        <span class="font-bold text-sm">ECG (12 Lead)</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600 cursor-pointer">
                        <input type="checkbox" class="w-6 h-6 text-blue-600 rounded">
                        <span class="font-bold text-sm">Blood Gas / Labs</span>
                    </label>
                </div>
            </div>
        </div>

    </main>

    <div id="sticky-footer" class="fixed bottom-0 left-0 w-full bg-white dark:bg-slate-800 border-t border-slate-300 dark:border-slate-700 p-3 z-40 sticky-footer transform translate-y-full transition-transform duration-300 flex items-center gap-2 no-print">
        <div class="flex-shrink-0 w-20 text-center border-r border-slate-200 dark:border-slate-600 pr-2">
            <div class="text-[10px] uppercase font-bold text-slate-400">Timer</div>
            <div id="footer-timer" class="text-xl font-mono font-black text-slate-800 dark:text-white">00:00</div>
        </div>
        
        <button id="footer-drug-btn" class="flex-1 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-200 border border-blue-200 dark:border-blue-700 rounded-lg font-bold py-3 active:scale-95 transition">
            + DRUG
        </button>
        <button id="footer-obs-btn" class="flex-1 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-200 border border-green-200 dark:border-green-700 rounded-lg font-bold py-3 active:scale-95 transition">
            + OBS
        </button>
    </div>

    <div id="drug-modal" class="fixed inset-0 hidden bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-xl shadow-2xl overflow-hidden animate-in slide-in-from-bottom duration-200">
            <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-black text-lg">Add Drug</h3>
                <button id="close-drug-modal" class="text-slate-400 hover:text-slate-600 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-4 grid grid-cols-2 gap-3">
                <button class="drug-select-btn drug-btn h-16 text-lg border-indigo-200 bg-indigo-50 text-indigo-800" data-drug="Propofol">Propofol</button>
                <button class="drug-select-btn drug-btn h-16 text-lg border-orange-200 bg-orange-50 text-orange-800" data-drug="Ketamine">Ketamine</button>
                <button class="drug-select-btn drug-btn h-16 text-lg border-blue-200 bg-blue-50 text-blue-800" data-drug="Midazolam">Midazolam</button>
                <button class="drug-select-btn drug-btn h-16 text-lg border-purple-200 bg-purple-50 text-purple-800" data-drug="Fentanyl">Fentanyl</button>
            </div>
            <div class="p-4 bg-slate-50 dark:bg-slate-700">
                 <input type="number" id="quick-drug-dose" placeholder="Dose (mg)" class="w-full p-3 text-xl font-bold rounded-lg border-slate-300 dark:bg-slate-600 dark:border-slate-500 mb-3">
                 <button id="confirm-drug-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">CONFIRM</button>
            </div>
        </div>
    </div>

    <div id="discharge-letter-view" class="hidden bg-white p-8 max-w-3xl mx-auto border shadow-2xl my-8 text-slate-900 print:block print:p-0 print:shadow-none print:border-none print:my-0 print:absolute print:top-0 print:left-0 print:w-full">
        <div class="no-print flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-xl font-bold text-slate-700">Preview: Discharge Letter</h2>
            <div class="flex gap-2">
                <button onclick="document.getElementById('discharge-letter-view').classList.add('hidden'); document.getElementById('main-app-container').classList.remove('hidden');" class="px-4 py-2 border rounded hover:bg-slate-100">Back</button>
                <button onclick="window.print()" class="px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 shadow">Print</button>
            </div>
        </div>
        <div class="font-[Inter] leading-snug">
             <div class="border-b-2 border-slate-800 pb-3 mb-4 flex justify-between items-start">
                <div>
                    <h1 class="text-xl font-black uppercase tracking-tight">Emergency Department</h1>
                    <p class="text-base font-bold text-slate-600">Discharge Advice Following Procedural Sedation</p>
                </div>
                <div class="text-right text-xs">
                    <p class="font-bold">Date: <span id="letter-date"></span></p>
                </div>
            </div>
            <div class="mb-4 text-sm"><p><strong>Procedure:</strong> <span id="letter-procedure"></span></p></div>
            <p class="mb-2 text-sm font-bold">Dear Patient,</p>
            <p class="mb-4 text-sm text-slate-800">Today you received: <span id="letter-drugs-given" class="font-bold"></span>.</p>
            <div class="bg-blue-50 border-l-4 border-blue-600 p-3 mb-4">
                <h3 class="font-bold text-blue-900 mb-1 uppercase text-sm">‚ö†Ô∏è The 24-Hour Safety Rules</h3>
                <div class="mb-2 text-sm font-semibold text-blue-800">
                    <p>No driving, operating machinery, signing documents, or alcohol until: <br><span id="letter-time-end" class="text-lg font-black bg-yellow-200 px-1"></span> on <span id="letter-date-end" class="font-bold"></span>.</p>
                </div>
            </div>
            <div class="mb-4"><h3 class="font-bold text-slate-900 border-b border-slate-300 mb-1 pb-1 text-sm">Supervision</h3><p class="text-sm">You must be accompanied home by a responsible adult who can stay with you for 24 hours.</p></div>
            <div class="mb-4"><h3 class="font-bold text-slate-900 border-b border-slate-300 mb-1 pb-1 text-sm">Side Effects</h3><ul id="letter-side-effects-list" class="list-disc ml-5 space-y-1 text-sm text-slate-700"></ul></div>
            <div class="mt-4 pt-4 border-t border-slate-200 text-xs text-slate-500"><p>Clinician Signature: __________________________</p></div>
        </div>
    </div>

    <template id="obs-row-template">
        <div class="grid grid-cols-6 gap-1 items-center bg-slate-50 dark:bg-slate-700/50 p-2 rounded border border-slate-200 dark:border-slate-600 text-xs mb-1">
            <div class="col-span-1 font-mono font-bold text-slate-500 row-time">--:--</div>
            <input type="number" placeholder="HR" class="col-span-1 p-1 text-center font-bold rounded border dark:bg-slate-600 dark:border-slate-500 obs-input">
            <input type="number" placeholder="BP" class="col-span-1 p-1 text-center font-bold rounded border dark:bg-slate-600 dark:border-slate-500 obs-input">
            <input type="number" placeholder="SpO2" class="col-span-1 p-1 text-center font-bold rounded border dark:bg-slate-600 dark:border-slate-500 obs-input">
            <input type="number" placeholder="RR" class="col-span-1 p-1 text-center font-bold rounded border dark:bg-slate-600 dark:border-slate-500 obs-input">
            <div class="col-span-1 text-center"><button class="text-red-500 font-bold px-2 py-1 bg-red-50 rounded hover:bg-red-100 dark:bg-slate-800 remove-btn">√ó</button></div>
        </div>
    </template>

    <template id="drug-row-template">
        <div class="flex justify-between items-center bg-blue-50 dark:bg-blue-900/20 p-2 rounded border border-blue-100 dark:border-blue-800 text-sm mb-1">
            <div class="flex gap-3 items-center">
                <span class="font-mono text-xs text-blue-400 row-time">--:--</span>
                <span class="font-bold text-blue-900 dark:text-blue-100 row-drug">Drug</span>
                <span class="font-black text-slate-800 dark:text-white row-dose">0mg</span>
            </div>
            <button class="text-red-400 hover:text-red-600 font-bold px-2 remove-btn">√ó</button>
        </div>
    </template>

    <script>
        // --- HELPERS ---
        window.setNow = (id) => {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            document.getElementById(id).value = timeStr;
            saveState();
        };

        window.toggleSection = (id) => {
            const el = document.getElementById(id);
            const header = el.previousElementSibling;
            const icon = header.querySelector('.toggle-icon');
            if (el.style.maxHeight) {
                el.style.maxHeight = null;
                el.classList.add('opacity-50');
                icon.style.transform = 'rotate(-90deg)';
            } else {
                el.style.maxHeight = el.scrollHeight + "px";
                el.classList.remove('opacity-50');
                icon.style.transform = 'rotate(0deg)';
            }
        };

        const val = (id) => document.getElementById(id)?.value || '';
        const isChecked = (id) => document.getElementById(id)?.checked;
        const findCheckedRadio = (name) => {
            const el = document.querySelector(`input[name="${name}"]:checked`);
            return el ? el.value : '';
        };

        document.addEventListener('DOMContentLoaded', () => {
            const $ = (id) => document.getElementById(id);

            // --- STATE & AUTO-SAVE ---
            let timerInterval = null;
            // We store startTime (timestamp) instead of elapsed seconds for robustness
            let startTime = null; 
            let elapsedWhenPaused = 0; 

            function saveState() {
                const data = {};
                // Inputs
                document.querySelectorAll('input, textarea, select').forEach(el => {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        if (el.checked) data[el.id || el.name + ':' + el.value] = true;
                    } else if (el.id) {
                        data[el.id] = el.value;
                    }
                });
                // Dynamic HTML
                data['drug-html'] = $('drug-table-container').innerHTML;
                data['obs-html'] = $('obs-table-container').innerHTML;
                
                // Timer State
                data['timer-start-time'] = startTime;
                data['timer-running'] = !!timerInterval;
                data['timer-elapsed-paused'] = elapsedWhenPaused;
                
                data['btn-proc-start'] = $('procedure-start-output').textContent;
                data['btn-proc-end'] = $('procedure-end-output').textContent;
                data['btn-awake'] = $('patient-awake-output').textContent;
                data['dose-output'] = $('dose-output').innerHTML;
                data['dose-visible'] = !$('dose-output').classList.contains('hidden');
                
                localStorage.setItem('sedation_v3_data', JSON.stringify(data));
                generateEPRLog();
            }

            function loadState() {
                const saved = localStorage.getItem('sedation_v3_data');
                if(!saved) return;
                try {
                    const data = JSON.parse(saved);
                    // Inputs
                    document.querySelectorAll('input, textarea, select').forEach(el => {
                        if (el.type === 'checkbox') {
                            if (data[el.id]) el.checked = true;
                        } else if (el.type === 'radio') {
                            if (data[el.name + ':' + el.value]) el.checked = true;
                        } else if (el.id && data[el.id] !== undefined) {
                            el.value = data[el.id];
                        }
                    });
                    
                    if(data['drug-html']) $('drug-table-container').innerHTML = data['drug-html'];
                    if(data['obs-html']) $('obs-table-container').innerHTML = data['obs-html'];
                    
                    // Re-attach listeners to dynamic elements
                    document.querySelectorAll('.remove-btn').forEach(btn => btn.onclick = (e) => { e.target.closest('div.flex, div.grid').remove(); saveState(); });
                    document.querySelectorAll('.obs-input').forEach(inp => inp.oninput = saveState);

                    // Restore Timer Logic
                    elapsedWhenPaused = data['timer-elapsed-paused'] || 0;
                    if(data['timer-running'] && data['timer-start-time']) {
                         startTime = data['timer-start-time'];
                         startTimerUI();
                    } else if (elapsedWhenPaused > 0) {
                         // Was paused, show the time
                         updateTimerDisplay(elapsedWhenPaused);
                         $('sticky-footer').classList.replace('translate-y-full', 'translate-y-0');
                    }
                    
                    if(data['btn-proc-start']) $('procedure-start-output').textContent = data['btn-proc-start'];
                    if(data['btn-proc-end']) $('procedure-end-output').textContent = data['btn-proc-end'];
                    if(data['btn-awake']) $('patient-awake-output').textContent = data['btn-awake'];
                    
                    if(data['dose-output']) $('dose-output').innerHTML = data['dose-output'];
                    if(data['dose-visible']) $('dose-output').classList.remove('hidden');
                    
                    generateEPRLog();
                } catch(e) { console.error(e); }
            }

            // --- LISTENERS FOR AUTO-SAVE ---
            document.body.addEventListener('input', (e) => { if(e.target.matches('input, textarea')) saveState(); });
            document.body.addEventListener('change', (e) => { if(e.target.matches('input, select')) saveState(); });

            // --- DARK MODE ---
            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            $('dark-mode-toggle').onclick = () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            };

            $('reset-btn').onclick = () => {
                if(confirm("Clear all data and reset form?")) {
                    localStorage.removeItem('sedation_v3_data');
                    location.reload();
                }
            };

            // --- TABS ---
            $('btn-tab-procedural').onclick = () => {
                $('tab-procedural').classList.remove('hidden');
                $('tab-agitated').classList.add('hidden');
                $('btn-tab-procedural').classList.add('border-blue-600', 'text-blue-800');
                $('btn-tab-procedural').classList.remove('border-transparent', 'text-slate-500');
                $('btn-tab-agitated').classList.remove('border-red-600', 'text-red-800');
                $('btn-tab-agitated').classList.add('border-transparent', 'text-slate-500');
            };
            $('btn-tab-agitated').onclick = () => {
                $('tab-agitated').classList.remove('hidden');
                $('tab-procedural').classList.add('hidden');
                $('btn-tab-agitated').classList.add('border-red-600', 'text-red-800');
                $('btn-tab-agitated').classList.remove('border-transparent', 'text-slate-500');
                $('btn-tab-procedural').classList.remove('border-blue-600', 'text-blue-800');
                $('btn-tab-procedural').classList.add('border-transparent', 'text-slate-500');
            };

            // --- TRAFFIC LIGHTS ---
            $('allergies').addEventListener('input', (e) => {
                $('allergy-container').classList.toggle('bg-red-100', e.target.value.length > 0);
                $('allergy-container').classList.toggle('border-red-300', e.target.value.length > 0);
            });
            const updateAirwayColor = () => {
                const card = $('airway-card');
                const m = findCheckedRadio('airway-mallampati');
                const ulbt = findCheckedRadio('airway-ulbt');
                const a = findCheckedRadio('asa-grade');
                const risk = m === 'IV' || m === 'III' || ulbt === '3' || a === 'IV' || a === 'III' || isChecked('airway-mouth') || isChecked('airway-neck') || isChecked('airway-tmd') || isChecked('airway-bmi');
                
                card.className = "p-3 border rounded-lg mb-4 transition-colors duration-300 " + 
                    (risk ? 'bg-orange-50 border-orange-300 dark:bg-orange-900/20 dark:border-orange-600' : 'bg-slate-50 border-slate-200 dark:bg-slate-700/30 dark:border-slate-600');
            };
            document.querySelectorAll('input[name="airway-mallampati"], input[name="airway-ulbt"], input[name="asa-grade"], .chk-input').forEach(el => el.addEventListener('change', updateAirwayColor));

            // --- CALCULATORS ---
            $('calculate-doses-button').onclick = () => {
                const w = parseFloat($('weight').value);
                if(!w) return alert("Enter weight first");
                const frail = isChecked('frail-elderly');
                
                const p_std_low = (0.5 * w).toFixed(0);
                const p_std_high = (1.0 * w).toFixed(0);
                const p_frail_low = (0.25 * w).toFixed(0); 
                const p_frail_high = (0.5 * w).toFixed(0);
                
                const k_diss_low = (1.0 * w).toFixed(0);
                const k_diss_high = (2.0 * w).toFixed(0); 
                
                const m_initial_low = 1; 
                const m_initial_high = Math.min(2.0, 0.05 * w).toFixed(1); 
                const f_initial_max_mcg = (0.5 * w).toFixed(0); 
                
                let p_output = frail 
                    ? `<strong>Propofol (Frail):</strong> ${p_frail_low}-${p_frail_high} mg`
                    : `<strong>Propofol (Adult):</strong> ${p_std_low}-${p_std_high} mg`;
                
                $('dose-output').innerHTML = `
                    <p class="mb-1">${p_output}</p>
                    <p class="mb-1"><strong>Ketamine:</strong> ${k_diss_low}-${k_diss_high} mg (Dissoc)</p>
                    <p class="mb-1"><strong>Midazolam:</strong> ${m_initial_low}-${m_initial_high} mg</p>
                    <p class="mb-1"><strong>Fentanyl:</strong> Max ${f_initial_max_mcg} mcg</p>
                `;
                $('dose-output').classList.remove('hidden');
                saveState();
            };

            $('calc-agitated-btn').onclick = () => {
                const w = parseFloat($('agitated-weight').value);
                if(w > 0) {
                    $('val-ket-im').textContent = (w * 4).toFixed(0);
                    $('val-ket-iv').textContent = (w * 1).toFixed(0);
                    $('agitated-output').classList.remove('hidden');
                }
            };

            // --- TIMER LOGIC (ROBUST) ---
            function updateTimerDisplay(totalSeconds) {
                const m = Math.floor(totalSeconds / 60).toString().padStart(2,'0');
                const s = Math.floor(totalSeconds % 60).toString().padStart(2,'0');
                $('timer-display').textContent = `${m}:${s}`;
                $('footer-timer').textContent = `${m}:${s}`;
            }

            function startTimerUI() {
                 timerInterval = setInterval(() => {
                    const now = Date.now();
                    const diff = Math.floor((now - startTime) / 1000) + elapsedWhenPaused;
                    updateTimerDisplay(diff);
                }, 1000);
                $('sedation-timer-button').textContent = "STOP TIMER";
                $('sedation-timer-button').classList.replace('bg-green-600', 'bg-red-600');
                $('sedation-timer-button').classList.replace('border-green-800', 'border-red-800');
                $('sticky-footer').classList.replace('translate-y-full', 'translate-y-0');
            }

            $('sedation-timer-button').onclick = () => {
                if(timerInterval) {
                    // STOP
                    clearInterval(timerInterval);
                    timerInterval = null;
                    const now = Date.now();
                    elapsedWhenPaused += Math.floor((now - startTime) / 1000);
                    startTime = null; // Reset current session start
                    
                    $('sedation-timer-button').textContent = "RESUME TIMER";
                    $('sedation-timer-button').classList.replace('bg-red-600', 'bg-green-600');
                    $('sedation-timer-button').classList.replace('border-red-800', 'border-green-800');
                } else {
                    // START
                    if(elapsedWhenPaused === 0) {
                        // First start
                        toggleSection('section-1-content');
                        toggleSection('section-2-content');
                        toggleSection('section-3-content');
                        addObsRow(); 
                    }
                    startTime = Date.now();
                    startTimerUI();
                }
                saveState();
            };

            // Timestamp Buttons
            ['procedure-start', 'procedure-end', 'patient-awake'].forEach(key => {
                $(`${key}-button`).onclick = function() {
                    $(`${key}-output`).textContent = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                    saveState();
                }
            });

            // --- ADDING ROWS ---
            function addObsRow() {
                const tmpl = $('obs-row-template').content.cloneNode(true);
                const now = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                tmpl.querySelector('.row-time').textContent = now;
                tmpl.querySelector('.remove-btn').onclick = (e) => { e.target.closest('.grid').remove(); saveState(); };
                tmpl.querySelectorAll('input').forEach(i => i.oninput = saveState);
                $('obs-table-container').prepend(tmpl);
                saveState();
            }
            $('footer-obs-btn').onclick = addObsRow;

            // Drug Modal
            let selectedDrug = null;
            $('footer-drug-btn').onclick = () => { $('drug-modal').classList.remove('hidden'); $('drug-modal').classList.add('flex'); };
            $('close-drug-modal').onclick = () => $('drug-modal').classList.add('hidden');
            
            document.querySelectorAll('.drug-select-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.drug-select-btn').forEach(b => b.classList.remove('ring-4', 'ring-blue-400'));
                    btn.classList.add('ring-4', 'ring-blue-400');
                    selectedDrug = btn.dataset.drug;
                    $('quick-drug-dose').focus();
                }
            });

            $('confirm-drug-btn').onclick = () => {
                const dose = $('quick-drug-dose').value;
                if(!selectedDrug || !dose) return;
                const tmpl = $('drug-row-template').content.cloneNode(true);
                tmpl.querySelector('.row-time').textContent = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                tmpl.querySelector('.row-drug').textContent = selectedDrug;
                tmpl.querySelector('.row-dose').textContent = dose + 'mg';
                tmpl.querySelector('.remove-btn').onclick = (e) => { e.target.closest('div.flex').remove(); saveState(); };
                $('drug-table-container').appendChild(tmpl);
                $('empty-drugs-msg').classList.add('hidden');
                $('drug-modal').classList.add('hidden');
                $('quick-drug-dose').value = '';
                document.querySelectorAll('.drug-select-btn').forEach(b => b.classList.remove('ring-4', 'ring-blue-400'));
                selectedDrug = null;
                saveState();
            };

            // --- DISCHARGE LETTER ---
            $('create-discharge-letter-btn').onclick = () => {
                 const now = new Date();
                 $('letter-date').textContent = now.toLocaleDateString();
                 const proc = val('procedure') || 'Sedation';
                 const indic = val('indication');
                 $('letter-procedure').textContent = indic ? `${proc} for ${indic}` : proc;
                 
                 // Get drugs given for side effects logic
                 let drugs = [];
                 document.querySelectorAll('.row-drug').forEach(el => drugs.push(el.textContent));
                 const uniqueDrugs = [...new Set(drugs)];
                 $('letter-drugs-given').textContent = uniqueDrugs.join(', ') || 'Sedation Medication';
                 
                 // Time Calc
                 const end = new Date(now.getTime() + 24*60*60*1000);
                 $('letter-time-end').textContent = end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                 $('letter-date-end').textContent = end.toLocaleDateString();

                 // Specific Side Effects Logic (Restored)
                 const ul = $('letter-side-effects-list');
                 ul.innerHTML = '';
                 const addLi = (txt) => { const li = document.createElement('li'); li.textContent = txt; ul.appendChild(li); };
                 
                 addLi("You may feel tired, dizzy, or unsteady. Rest today.");
                 addLi("Amnesia (forgetting the event) is normal.");
                 
                 const dStr = uniqueDrugs.join(' ').toLowerCase();
                 if(dStr.includes('ketamine')) addLi("Ketamine can cause vivid dreams. Rest in a quiet, low-light room.");
                 if(dStr.includes('propofol')) addLi("Propofol may leave you feeling groggy.");
                 if(dStr.includes('fentanyl') || dStr.includes('morphine')) addLi("Strong painkillers can cause nausea or itching.");
                 
                 $('main-app-container').classList.add('hidden');
                 $('discharge-letter-view').classList.remove('hidden');
                 window.scrollTo(0,0);
            };

            // --- EPR LOG GENERATOR (FULL) ---
            function generateEPRLog() {
                let log = `<strong>PROCEDURAL SEDATION RECORD</strong><br>`;
                log += `Procedure: ${val('procedure')} | Indication: ${val('indication')}<br>`;
                log += `Staff: ${val('sedationist')} (Sed), ${val('sedationist-grade')}<br>`;
                log += `Patient: ${val('age')}yrs | ${val('weight')}kg ${isChecked('weight-estimated')?'(Est)':''} | ASA ${findCheckedRadio('asa-grade')}<br>`;
                log += `Allergies: ${val('allergies') || 'NKDA'} | Fasting: Food ${val('last-food')} Fluid ${val('last-fluid')}<br>`;
                
                // Risk/Airway
                const mall = findCheckedRadio('airway-mallampati');
                const ulbt = findCheckedRadio('airway-ulbt');
                const risks = [];
                if(isChecked('risk-nausea')) risks.push('Nausea');
                if(isChecked('risk-resp-depress')) risks.push('Hypoxia');
                if(isChecked('risk-laryngospasm')) risks.push('Laryngospasm');
                if(isChecked('risk-aspiration')) risks.push('Aspiration');
                if(isChecked('risk-allergy')) risks.push('Anaphylaxis');
                
                let airwayIssues = [];
                if(mall === 'III' || mall === 'IV') airwayIssues.push(`Mallampati ${mall}`);
                if(ulbt === '3') airwayIssues.push('ULBT 3');
                if(isChecked('airway-mouth')) airwayIssues.push('Mouth<3cm');
                
                if(airwayIssues.length) log += `<strong>AIRWAY ALERT: ${airwayIssues.join(', ')}</strong><br>`;
                if(risks.length) log += `Risks Discussed: ${risks.join(', ')}<br>`;
                
                // Drugs
                const drugs = [];
                document.querySelectorAll('.row-drug').forEach((el, i) => {
                    const dose = document.querySelectorAll('.row-dose')[i].textContent;
                    const time = document.querySelectorAll('.row-time')[i].textContent;
                    drugs.push(`${time} ${el.textContent} ${dose}`);
                });
                if(drugs.length) log += `<br><strong>Drugs:</strong><br>${drugs.join('<br>')}<br>`;
                
                // Vitals
                const vitals = [];
                document.querySelectorAll('.obs-input').forEach((el, i) => {
                    if(i % 4 === 0 && el.value) { // HR is index 0, 4, 8...
                        const row = el.closest('.grid');
                        const t = row.querySelector('.row-time').textContent;
                        const hr = el.value; 
                        const bp = row.querySelectorAll('.obs-input')[1].value;
                        const sp = row.querySelectorAll('.obs-input')[2].value;
                        const rr = row.querySelectorAll('.obs-input')[3].value;
                        vitals.push(`${t}: HR${hr} BP${bp} SaO2${sp}% RR${rr}`);
                    }
                });
                if(vitals.length) log += `<br><strong>Vitals:</strong><br>${vitals.join('<br>')}<br>`;
                
                // Discharge
                const dc = [];
                if(isChecked('dc-vitals')) dc.push('Vitals OK');
                if(isChecked('dc-aao')) dc.push('A&O');
                if(isChecked('dc-home')) dc.push('Escort present');
                
                log += `<br>Outcome: ${findCheckedRadio('outcome-proc')}<br>`;
                if(dc.length) log += `DC Criteria: ${dc.join(', ')}<br>`;
                log += `Signed: ${val('signoff-name')} @ ${val('signoff-time')}`;
                
                $('epr-log-output').innerHTML = log;
            }
            
            // Start Tabs & Accordions
            loadState();
            ['section-1-content', 'section-2-content', 'section-3-content'].forEach(id => {
               const el = $(id); el.style.maxHeight = el.scrollHeight + "px";
            });
            $('header-print-btn').onclick = () => window.print();
            $('header-print-letter-btn').onclick = $('create-discharge-letter-btn').onclick;
            $('copy-log-button').onclick = () => {
                navigator.clipboard.writeText($('epr-log-output').innerText);
                const btn = $('copy-log-button');
                const orig = btn.innerText;
                btn.innerText = "COPIED!";
                setTimeout(()=>btn.innerText = orig, 1000);
            };
        });
    </script>
</body>
</html>
