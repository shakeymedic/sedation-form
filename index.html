<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sedation & Agitation Management Tool</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { slate: { 850: '#1e293b' } }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORE STYLES --- */
        body { font-family: 'Inter', sans-serif; }
        html { scroll-behavior: smooth; }
        
        /* Transitions for Accordions */
        .transition-height { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Inputs */
        input, textarea, select { outline: none; transition: all 0.2s; }
        input:focus, textarea:focus, select:focus { ring: 2px; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); border-color: #2563eb; }
        
        .dark input, .dark textarea, .dark select { 
            background-color: #334155; 
            border-color: #475569; 
            color: #f8fafc; 
        }
        .dark input::placeholder { color: #94a3b8; }

        /* Touch Targets */
        .touch-group-label {
            @apply flex items-center justify-center p-3 border-2 rounded-lg cursor-pointer transition-all select-none font-bold text-sm text-center bg-white text-slate-600 border-slate-200 hover:bg-slate-50;
        }
        .touch-group-label.dark-mode-target {
            @apply dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700;
        }
        
        /* Active States for Button Groups */
        .peer:checked + .touch-group-label {
            @apply bg-blue-600 text-white border-blue-700 shadow-md transform scale-[1.02];
        }
        .peer:checked + .touch-group-label-red {
            @apply bg-red-600 text-white border-red-700 shadow-md transform scale-[1.02];
        }
        .peer:checked + .touch-group-label-amber {
            @apply bg-amber-500 text-white border-amber-600 shadow-md transform scale-[1.02];
        }

        /* Checkbox Custom Style */
        .chk-label {
            @apply flex items-center gap-2 p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer text-xs font-bold text-slate-700 dark:text-slate-300 transition;
        }
        .chk-input {
            @apply w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 dark:bg-slate-600 dark:border-slate-500 dark:checked:bg-blue-600 dark:checked:border-blue-600;
        }

        /* Drug Buttons */
        .drug-btn {
            @apply bg-white border border-slate-300 text-slate-600 font-bold text-xs px-3 py-3 rounded-lg shadow-sm transition-all hover:bg-slate-50 active:scale-95 flex-grow text-center min-w-[80px];
        }
        .dark .drug-btn {
            @apply bg-slate-800 border-slate-600 text-slate-300 hover:bg-slate-700;
        }

        /* Rich Text Output (Matching Trauma Tool) */
        .rich-output {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.85rem;
            line-height: 1.4;
            color: #334155;
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 1rem;
            min-height: 24rem;
            overflow-y: auto;
            white-space: pre-wrap; 
        }
        .dark .rich-output {
            background-color: #1e293b;
            color: #cbd5e1;
            border-color: #475569;
        }
        .rich-output strong { font-weight: 800; color: #0f172a; }
        .dark .rich-output strong { color: white; }

        /* Agitated Warning */
        .agitated-warning {
            background: repeating-linear-gradient(45deg, #fffbeb, #fffbeb 10px, #fef3c7 10px, #fef3c7 20px);
        }
        .dark .agitated-warning {
            background: repeating-linear-gradient(45deg, #450a0a, #450a0a 10px, #7f1d1d 10px, #7f1d1d 20px);
        }

        /* Print Hiding */
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; }
            .section-card { break-inside: avoid; border: 1px solid #ccc !important; box-shadow: none !important; }
            .dark { color-scheme: light; } 
            .dark .section-card { background: white !important; color: black !important; }
            #sticky-footer { display: none !important; }
            .transition-height { max-height: none !important; opacity: 1 !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 dark:bg-slate-900 dark:text-slate-100 antialiased pb-24 transition-colors duration-200">

    <header class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-50 border-b border-slate-300 dark:border-slate-700 no-print">
        <div class="container mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://iili.io/KGQOvkl.md.png" alt="Logo" class="h-10 md:h-12 w-auto object-contain">
                <div>
                    <h1 class="text-lg md:text-xl font-black leading-tight">Sedation Record</h1>
                    <p class="text-[10px] text-green-600 font-bold flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Auto-save enabled
                    </p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button id="dark-mode-toggle" class="p-2 rounded-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition" title="Toggle Dark Mode">
                    <span class="dark:hidden">üåô</span>
                    <span class="hidden dark:inline">‚òÄÔ∏è</span>
                </button>
                <button id="reset-btn" class="px-3 py-2 bg-red-100 text-red-700 text-xs font-bold rounded hover:bg-red-200 transition">RESET</button>
            </div>
        </div>
        
        <div id="tabs-container" class="container mx-auto px-4 flex gap-4 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800">
            <button id="btn-tab-procedural" class="flex-1 py-3 text-sm font-black text-center border-b-4 border-blue-600 text-blue-800 dark:text-blue-400 transition-colors">Standard Sedation</button>
            <button id="btn-tab-agitated" class="flex-1 py-3 text-sm font-black text-center border-b-4 border-transparent text-slate-500 hover:text-red-600 dark:text-slate-400 transition-colors">üö® Agitated Patient</button>
        </div>
    </header>

    <main id="main-app-container" class="container mx-auto px-4 py-4 max-w-7xl"> 
        
        <div id="tab-procedural" class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <div class="lg:col-span-8 flex flex-col gap-4">
                
                <div class="sticky top-[105px] z-40 bg-slate-100/95 dark:bg-slate-900/95 backdrop-blur-sm py-2 -mt-2 mb-2 flex gap-2 overflow-x-auto no-print border-b border-slate-200 dark:border-slate-700 hide-scrollbar" style="top: 105px;">
                    <button onclick="scrollToSection('section-1-content')" class="flex-shrink-0 px-3 py-1.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-full shadow-sm text-[10px] font-black uppercase text-slate-600 dark:text-slate-300 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 transition-colors">1. Patient</button>
                    <button onclick="scrollToSection('section-2-content')" class="flex-shrink-0 px-3 py-1.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-full shadow-sm text-[10px] font-black uppercase text-slate-600 dark:text-slate-300 hover:bg-orange-50 hover:text-orange-600 hover:border-orange-300 transition-colors">2. Assessment</button>
                    <button onclick="scrollToSection('section-3-content')" class="flex-shrink-0 px-3 py-1.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-full shadow-sm text-[10px] font-black uppercase text-slate-600 dark:text-slate-300 hover:bg-green-50 hover:text-green-600 hover:border-green-300 transition-colors">3. Plan</button>
                    <button onclick="scrollToSection('section-4')" class="flex-shrink-0 px-3 py-1.5 bg-slate-800 dark:bg-slate-700 border border-slate-900 rounded-full shadow-sm text-[10px] font-black uppercase text-white hover:bg-slate-700 transition-colors">‚è±Ô∏è Timer</button>
                    <button onclick="scrollToSection('section-5')" class="flex-shrink-0 px-3 py-1.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-full shadow-sm text-[10px] font-black uppercase text-slate-600 dark:text-slate-300 hover:bg-purple-50 hover:text-purple-600 hover:border-purple-300 transition-colors">5. Discharge</button>
                </div>

                <form id="sedation-form" onsubmit="return false;">
                    <div class="flex flex-col gap-4">

                        <div id="section-1" class="section-card bg-white dark:bg-slate-800 border-l-[6px] border-l-blue-600 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4 transition-all scroll-mt-36">
                            <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="toggleSection('section-1-content')">
                                <h2 class="text-lg font-black text-blue-800 dark:text-blue-400">1. Patient & Procedure</h2>
                                <span class="text-xs text-slate-400 toggle-icon">‚ñº</span>
                            </div>
                            
                            <div id="section-1-content" class="transition-height overflow-hidden">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-2">
                                    <div class="md:col-span-2">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Age</label>
                                        <input type="number" id="pt_age" placeholder="Yr" class="p-2 border rounded-lg w-full font-bold dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Weight (kg) <span class="text-red-500">*</span></label>
                                        <div class="flex gap-2">
                                            <input type="number" id="pt_weight" placeholder="kg" class="p-2 border rounded-lg w-full font-bold dark:bg-slate-700 dark:border-slate-600">
                                            <label class="cursor-pointer relative min-w-[60px]">
                                                <input type="checkbox" id="pt_estWeight" class="peer sr-only">
                                                <div class="h-full flex items-center justify-center border rounded-lg bg-slate-50 text-slate-500 font-bold text-[10px] uppercase peer-checked:bg-blue-600 peer-checked:text-white dark:bg-slate-700 dark:border-slate-600 transition">Est</div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Allergies</label>
                                        <div id="allergy-container" class="transition-colors rounded-lg">
                                            <input type="text" id="pt_allergies" placeholder="Reaction details..." class="w-full p-2 border rounded-lg font-bold text-red-700 dark:text-red-400 border-slate-300 dark:bg-slate-700 dark:border-slate-600">
                                        </div>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Procedure</label>
                                        <input type="text" id="pt_procedure" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Indication</label>
                                        <input type="text" id="pt_indication" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Pre-Sedation Analgesia</label>
                                        <input type="text" id="pt_preAnalgesia" placeholder="e.g. IV Morphine" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                    
                                    <div class="md:col-span-4 grid grid-cols-2 gap-4 border-t pt-2 dark:border-slate-600 mt-2">
                                        <div><label class="text-[10px] font-bold uppercase">Sedationist</label><input type="text" id="st_sed" class="w-full p-1 border rounded text-xs dark:bg-slate-700 dark:border-slate-600"></div>
                                        <div><label class="text-[10px] font-bold uppercase">Grade</label><input type="text" id="st_grade" class="w-full p-1 border rounded text-xs dark:bg-slate-700 dark:border-slate-600"></div>
                                        <div><label class="text-[10px] font-bold uppercase">Proc. Doctor</label><input type="text" id="st_doc" class="w-full p-1 border rounded text-xs dark:bg-slate-700 dark:border-slate-600"></div>
                                        <div><label class="text-[10px] font-bold uppercase">Nurse</label><input type="text" id="st_nurse" class="w-full p-1 border rounded text-xs dark:bg-slate-700 dark:border-slate-600"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="section-2" class="section-card bg-white dark:bg-slate-800 border-l-[6px] border-l-orange-500 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4 scroll-mt-36">
                            <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="toggleSection('section-2-content')">
                                <h2 class="text-lg font-black text-orange-800 dark:text-orange-400">2. Assessment & Risks</h2>
                                <span class="text-xs text-slate-400 toggle-icon">‚ñº</span>
                            </div>

                            <div id="section-2-content" class="transition-height overflow-hidden">
                                <div class="mb-4">
                                    <label class="text-xs font-bold text-slate-500 uppercase mb-1">Has Capacity?</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="cursor-pointer"><input type="radio" name="ass_capacity" value="Yes" class="peer sr-only"><div class="touch-group-label dark-mode-target">YES</div></label>
                                        <label class="cursor-pointer"><input type="radio" name="ass_capacity" value="No" class="peer sr-only"><div class="touch-group-label text-red-700 dark-mode-target">NO</div></label>
                                    </div>
                                </div>

                                <div id="airway-card" class="p-3 border rounded-lg mb-4 bg-slate-50 dark:bg-slate-700/30 dark:border-slate-600 transition-colors duration-300">
                                    <label class="text-xs font-black text-slate-600 dark:text-slate-400 uppercase border-b border-slate-300 dark:border-slate-600 pb-1 mb-2 block">Airway Assessment</label>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <span class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Mallampati</span>
                                            <div class="flex gap-1">
                                                <label class="flex-1 cursor-pointer"><input type="radio" name="ass_mallampati" value="I" class="peer sr-only"><div class="touch-group-label dark-mode-target py-2">I</div></label>
                                                <label class="flex-1 cursor-pointer"><input type="radio" name="ass_mallampati" value="II" class="peer sr-only"><div class="touch-group-label dark-mode-target py-2">II</div></label>
                                                <label class="flex-1 cursor-pointer"><input type="radio" name="ass_mallampati" value="III" class="peer sr-only"><div class="touch-group-label-amber dark-mode-target py-2">III</div></label>
                                                <label class="flex-1 cursor-pointer"><input type="radio" name="ass_mallampati" value="IV" class="peer sr-only"><div class="touch-group-label-red dark-mode-target py-2">IV</div></label>
                                            </div>
                                        </div>
                                        <div>
                                            <span class="text-[10px] font-bold text-slate-500 uppercase block mb-1">ULBT (Upper Lip Bite)</span>
                                            <div class="flex gap-1">
                                                 <label class="flex-1 cursor-pointer"><input type="radio" name="ass_ulbt" value="1" class="peer sr-only"><div class="touch-group-label dark-mode-target py-2">1</div></label>
                                                 <label class="flex-1 cursor-pointer"><input type="radio" name="ass_ulbt" value="2" class="peer sr-only"><div class="touch-group-label dark-mode-target py-2">2</div></label>
                                                 <label class="flex-1 cursor-pointer"><input type="radio" name="ass_ulbt" value="3" class="peer sr-only"><div class="touch-group-label-red dark-mode-target py-2">3</div></label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <span class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Difficult Airway Predictors</span>
                                        <div class="flex flex-wrap gap-3">
                                            <label class="chk-label"><input type="checkbox" class="chk-input pred-chk" value="Mouth < 3cm"> Mouth &lt;3cm</label>
                                            <label class="chk-label"><input type="checkbox" class="chk-input pred-chk" value="Thyromental < 6cm"> Thyromental &lt;6cm</label>
                                            <label class="chk-label"><input type="checkbox" class="chk-input pred-chk" value="Neck Immobile"> Neck Immobile</label>
                                            <label class="chk-label"><input type="checkbox" class="chk-input pred-chk" value="BMI > 35"> BMI &gt;35</label>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2 pt-2 border-t border-slate-200 dark:border-slate-600">
                                         <div class="flex justify-between items-center mb-1">
                                             <span class="text-[10px] font-bold text-slate-500 uppercase">ASA Grade</span>
                                         </div>
                                         <div class="flex gap-1">
                                                <label class="flex-1 cursor-pointer"><input type="radio" name="ass_asa" value="I" class="peer sr-only"><div class="touch-group-label dark-mode-target py-2">I</div></label>
                                                <label class="flex-1 cursor-pointer"><input type="radio" name="ass_asa" value="II" class="peer sr-only"><div class="touch-group-label dark-mode-target py-2">II</div></label>
                                                <label class="flex-1 cursor-pointer"><input type="radio" name="ass_asa" value="III" class="peer sr-only"><div class="touch-group-label-amber dark-mode-target py-2">III</div></label>
                                                <label class="flex-1 cursor-pointer"><input type="radio" name="ass_asa" value="IV" class="peer sr-only"><div class="touch-group-label-red dark-mode-target py-2">IV</div></label>
                                         </div>
                                    </div>
                                </div>

                                <div class="mb-4 bg-slate-50 dark:bg-slate-700/30 p-3 rounded-lg border border-slate-200 dark:border-slate-600">
                                    <label class="text-xs font-black text-slate-600 dark:text-slate-400 uppercase border-b border-slate-300 dark:border-slate-600 pb-1 mb-2 block">Risk Discussion</label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <span class="text-[10px] font-bold text-slate-500 uppercase">Common (>1:100)</span>
                                            <div class="space-y-1">
                                                <label class="chk-label"><input type="checkbox" class="chk-input risk-chk" value="Nausea/Vomiting"> Nausea/Vomiting</label>
                                                <label class="chk-label"><input type="checkbox" class="chk-input risk-chk" value="Drowsiness"> Drowsiness</label>
                                                <label class="chk-label"><input type="checkbox" class="chk-input risk-chk" value="Hypotension"> Hypotension</label>
                                                <label class="chk-label"><input type="checkbox" class="chk-input risk-chk" value="Hypoxia/Resp Dep"> Hypoxia/Resp. Dep</label>
                                            </div>
                                        </div>
                                        <div>
                                            <span class="text-[10px] font-bold text-red-500 uppercase">Rare (~1:1000)</span>
                                            <div class="space-y-1">
                                                <label class="chk-label text-red-700"><input type="checkbox" class="chk-input risk-chk" value="Laryngospasm"> Laryngospasm</label>
                                                <label class="chk-label text-red-700"><input type="checkbox" class="chk-input risk-chk" value="Aspiration"> Aspiration</label>
                                                <label class="chk-label text-red-700"><input type="checkbox" class="chk-input risk-chk" value="Anaphylaxis"> Anaphylaxis</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4 mb-2">
                                    <div><label class="text-[10px] uppercase font-bold text-slate-500">Last Food</label><input type="time" id="ass_lastFood" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600"></div>
                                    <div><label class="text-[10px] uppercase font-bold text-slate-500">Last Fluid</label><input type="time" id="ass_lastFluid" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600"></div>
                                </div>
                            </div>
                        </div>

                        <div id="section-3" class="section-card bg-white dark:bg-slate-800 border-l-[6px] border-l-green-500 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4 scroll-mt-36">
                            <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="toggleSection('section-3-content')">
                                <h2 class="text-lg font-black text-green-800 dark:text-green-400">3. Plan & Safety</h2>
                                <span class="text-xs text-slate-400 toggle-icon">‚ñº</span>
                            </div>
                            
                            <div id="section-3-content" class="transition-height overflow-hidden">
                                <label class="text-xs font-bold text-slate-500 uppercase mb-1">SOAP-ME Checklist</label>
                                <div class="grid grid-cols-5 gap-1 mb-4">
                                    <label class="cursor-pointer"><input type="checkbox" class="peer sr-only soap-chk" value="Suction"><div class="touch-group-label dark-mode-target text-xs p-2">SUCT</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="peer sr-only soap-chk" value="Oxygen"><div class="touch-group-label dark-mode-target text-xs p-2">OXYG</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="peer sr-only soap-chk" value="Airway"><div class="touch-group-label dark-mode-target text-xs p-2">AIRW</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="peer sr-only soap-chk" value="Monitoring"><div class="touch-group-label dark-mode-target text-xs p-2">MONI</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="peer sr-only soap-chk" value="Equipment"><div class="touch-group-label dark-mode-target text-xs p-2">ENV</div></label>
                                </div>
                                
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 p-3 rounded-lg">
                                    <label class="text-xs font-black text-yellow-800 dark:text-yellow-500 uppercase mb-2 block">üõë Safety Time Out</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="cursor-pointer"><input type="checkbox" class="peer sr-only time-chk" value="Identity"><div class="touch-group-label dark-mode-target">ID</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" class="peer sr-only time-chk" value="Roles"><div class="touch-group-label dark-mode-target">Roles</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" class="peer sr-only time-chk" value="Site"><div class="touch-group-label dark-mode-target">Site</div></label>
                                        <label class="cursor-pointer"><input type="checkbox" class="peer sr-only time-chk" value="Monitoring"><div class="touch-group-label dark-mode-target">Monit</div></label>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <label class="text-xs font-bold text-slate-500 uppercase">Pre-Vitals</label>
                                    <div class="grid grid-cols-4 gap-2">
                                        <input type="text" id="pv_hr" placeholder="HR" class="p-2 border rounded text-center dark:bg-slate-700 dark:border-slate-600">
                                        <input type="text" id="pv_bp" placeholder="BP" class="p-2 border rounded text-center dark:bg-slate-700 dark:border-slate-600">
                                        <input type="text" id="pv_spo2" placeholder="SpO2" class="p-2 border rounded text-center dark:bg-slate-700 dark:border-slate-600">
                                        <input type="text" id="pv_rr" placeholder="RR" class="p-2 border rounded text-center dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="section-4" class="bg-slate-800 dark:bg-black rounded-xl p-4 text-white shadow-lg border-2 border-slate-900 page-break scroll-mt-36">
                            <div class="flex flex-col items-center justify-center gap-4 mb-4">
                                <div class="w-full flex justify-between items-center mb-2">
                                    <span class="text-xs uppercase font-bold text-slate-400">Sedation Timer</span>
                                    <button type="button" onclick="document.getElementById('complications-guide').classList.toggle('hidden')" class="text-xs bg-slate-700 px-2 py-1 rounded hover:bg-slate-600">Emergency Guide</button>
                                </div>
                                <div id="complications-guide" class="hidden w-full text-xs text-yellow-300 bg-slate-700 p-2 rounded mb-2 border border-yellow-600">
                                    <strong>TROOPS/SIVA Quick Ref:</strong><br>‚Ä¢ Laryngospasm: 100% O‚ÇÇ / Jaw Thrust / Succinylcholine<br>‚Ä¢ Hypotension: Fluids / Metaraminol<br>‚Ä¢ Apnoea: BVM / Airway adjuncts
                                </div>
                                <div id="timer-display" class="text-6xl md:text-7xl font-mono font-black tracking-widest text-white tabular-nums">00:00</div>
                                <button type="button" id="sedation-timer-button" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-black text-xl rounded-lg shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all">START SEDATION TIMER</button>
                            </div>
                            <div class="grid grid-cols-3 gap-2 border-t border-slate-700 pt-4">
                                <div class="text-center"><button type="button" id="btn-proc-start" class="w-full py-2 bg-slate-700 rounded text-slate-300 font-bold text-xs border border-slate-600 hover:bg-slate-600">PROC START</button><span id="out-proc-start" class="text-xs font-mono text-green-400 block h-4 mt-1"></span></div>
                                <div class="text-center"><button type="button" id="btn-proc-end" class="w-full py-2 bg-slate-700 rounded text-slate-300 font-bold text-xs border border-slate-600 hover:bg-slate-600">PROC END</button><span id="out-proc-end" class="text-xs font-mono text-green-400 block h-4 mt-1"></span></div>
                                <div class="text-center"><button type="button" id="btn-awake" class="w-full py-2 bg-slate-700 rounded text-slate-300 font-bold text-xs border border-slate-600 hover:bg-slate-600">AWAKE</button><span id="out-awake" class="text-xs font-mono text-green-400 block h-4 mt-1"></span></div>
                            </div>
                        </div>

                        <div class="section-card bg-white dark:bg-slate-800 border-l-[6px] border-l-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4">
                            <div class="mb-6">
                                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Drugs Given</label>
                                <div id="drug-table-container" class="space-y-2"></div> 
                                <div id="empty-drugs-msg" class="text-sm text-slate-400 italic text-center py-2">No drugs recorded yet</div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Observations (q5min)</label>
                                <div id="obs-table-container" class="space-y-2"></div>
                            </div>
                            <div class="mt-4">
                                <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Notes</label>
                                <textarea id="general-notes" rows="3" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600" placeholder="Additional clinical notes..."></textarea>
                            </div>
                        </div>

                        <div id="section-5" class="section-card bg-white dark:bg-slate-800 border-l-[6px] border-l-purple-600 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4 scroll-mt-36">
                            <h2 class="text-lg font-black text-purple-800 dark:text-purple-400 mb-4">5. Discharge & Checklist</h2>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <label class="cursor-pointer"><input type="radio" name="outcome" value="Successful" class="peer sr-only"><div class="touch-group-label dark-mode-target py-4">SUCCESSFUL</div></label>
                                <label class="cursor-pointer"><input type="radio" name="outcome" value="Unsuccessful" class="peer sr-only"><div class="touch-group-label text-red-700 dark-mode-target py-4">FAILED</div></label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4 p-3 bg-purple-50 dark:bg-purple-900/20 rounded">
                                <label class="chk-label"><input type="checkbox" class="chk-input dc-chk" value="Baseline Vitals"> Baseline Vitals</label>
                                <label class="chk-label"><input type="checkbox" class="chk-input dc-chk" value="Alert & Orientated"> Alert & Orientated</label>
                                <label class="chk-label"><input type="checkbox" class="chk-input dc-chk" value="Tolerating Fluids"> Tolerating Fluids</label>
                                <label class="chk-label"><input type="checkbox" class="chk-input dc-chk" value="Pain Managed"> Pain Managed</label>
                                <label class="chk-label"><input type="checkbox" class="chk-input dc-chk" value="Carer / Home"> Carer / Home</label>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label class="text-[10px] uppercase font-bold">Sign-off Name</label><input type="text" id="dc_signName" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600"></div>
                                <div><label class="text-[10px] uppercase font-bold">Time</label>
                                    <div class="flex gap-1">
                                        <input type="time" id="dc_signTime" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                                        <button type="button" onclick="setNow('dc_signTime')" class="bg-slate-200 dark:bg-slate-600 text-xs font-bold px-2 rounded">NOW</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div> 

            <div class="lg:col-span-4 relative no-print">
                <div class="sticky top-24 h-fit space-y-4">
                    <div id="epr-log-container" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-lg border border-slate-300 dark:border-slate-700">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wide">EPR Quick Log</h2>
                            <button type="button" id="copy-log-button" class="px-3 py-1 text-xs font-bold bg-blue-600 text-white rounded hover:bg-blue-700 transition shadow-sm">Copy Rich Text</button>
                        </div>
                        <div id="epr-log-output" class="rich-output focus:ring-2 ring-blue-500 ring-offset-2 text-xs" contenteditable="true"></div>
                    </div>
                </div>
            </div>

        </div>

        <div id="tab-agitated" class="hidden">
            <div class="agitated-warning border-l-[10px] border-l-red-600 shadow-lg rounded-r-xl p-6 mb-6">
                <h1 class="text-2xl md:text-4xl font-black text-red-900 uppercase leading-none">Agitated Patient Protocol</h1>
                <p class="text-red-800 font-bold mt-2 text-sm uppercase">Immediate Threat to Safety</p>
            </div>
            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow border border-slate-200 dark:border-slate-700 mb-6">
                <label class="block text-slate-500 font-bold text-xs uppercase mb-1">Estimated Weight (kg)</label>
                <div class="flex gap-2 mb-4">
                    <input type="number" id="ag_weight" placeholder="kg" class="text-3xl font-black w-full p-3 border-2 border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-red-500">
                </div>
                <div id="agitated-output" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-red-50 dark:bg-red-900/30 border-2 border-red-500 rounded-xl p-4 text-center">
                        <span class="block text-xs font-black text-red-600 dark:text-red-400 uppercase tracking-widest mb-2">IM Ketamine (4mg/kg)</span>
                        <span id="val-ket-im" class="block text-6xl md:text-7xl font-black text-slate-900 dark:text-white leading-none tracking-tighter my-2">--</span>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/30 border-2 border-orange-400 rounded-xl p-4 text-center opacity-75">
                         <span class="block text-xs font-black text-orange-600 dark:text-orange-400 uppercase tracking-widest mb-2">IV Ketamine (1mg/kg)</span>
                         <span id="val-ket-iv" class="block text-5xl font-black text-slate-900 dark:text-white leading-none tracking-tighter my-2">--</span>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="sticky-footer" class="fixed bottom-0 left-0 w-full bg-white dark:bg-slate-800 border-t border-slate-300 dark:border-slate-700 p-3 z-40 sticky-footer transform translate-y-full transition-transform duration-300 flex items-center gap-2 no-print">
        <div class="flex-shrink-0 w-20 text-center border-r border-slate-200 dark:border-slate-600 pr-2">
            <div class="text-[10px] uppercase font-bold text-slate-400">Timer</div>
            <div id="footer-timer" class="text-xl font-mono font-black text-slate-800 dark:text-white">00:00</div>
        </div>
        <button id="footer-drug-btn" class="flex-1 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-200 border border-blue-200 dark:border-blue-700 rounded-lg font-bold py-3 active:scale-95 transition">+ DRUG</button>
        <button id="footer-obs-btn" class="flex-1 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-200 border border-green-200 dark:border-green-700 rounded-lg font-bold py-3 active:scale-95 transition">+ OBS</button>
    </div>

    <div id="drug-modal" class="fixed inset-0 hidden bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-xl shadow-2xl overflow-hidden animate-in slide-in-from-bottom duration-200">
            <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-black text-lg">Add Drug</h3>
                <button id="close-drug-modal" class="text-slate-400 hover:text-slate-600 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-4 grid grid-cols-2 gap-3">
                <button class="drug-select-btn drug-btn h-16 text-lg border-indigo-200 bg-indigo-50 text-indigo-800" data-drug="Propofol">Propofol</button>
                <button class="drug-select-btn drug-btn h-16 text-lg border-orange-200 bg-orange-50 text-orange-800" data-drug="Ketamine">Ketamine</button>
                <button class="drug-select-btn drug-btn h-16 text-lg border-blue-200 bg-blue-50 text-blue-800" data-drug="Midazolam">Midazolam</button>
                <button class="drug-select-btn drug-btn h-16 text-lg border-purple-200 bg-purple-50 text-purple-800" data-drug="Fentanyl">Fentanyl</button>
            </div>
            <div class="p-4 bg-slate-50 dark:bg-slate-700">
                 <input type="number" id="quick-drug-dose" placeholder="Dose (mg/mcg)" class="w-full p-3 text-xl font-bold rounded-lg border-slate-300 dark:bg-slate-600 dark:border-slate-500 mb-3">
                 <button id="confirm-drug-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">CONFIRM</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const $ = (id) => document.getElementById(id);
            const getTime = () => new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

            // --- CENTRAL DATA STORE ---
            let patientData = {
                pt: { age:'', weight:'', estWeight:false, allergies:'', procedure:'', indication:'', preAnalgesia:'' },
                staff: { sed:'', grade:'', doc:'', nurse:'' },
                assess: { capacity:'Yes', mallampati:'', ulbt:'', asa:'', predictors:[], risks:[], lastFood:'', lastFluid:'' },
                plan: { soap:[], timeout:[], preVitals:{hr:'',bp:'',spo2:'',rr:''} },
                proc: { start:'', end:'', awake:'', drugs:[], obs:[], notes:'' },
                agitated: { weight:'' },
                dc: { outcome:'', criteria:[], signName:'', signTime:'' },
                timer: { start: null, pausedElapsed: 0, running: false }
            };

            // --- SAVE & LOAD ---
            function saveState() {
                localStorage.setItem('sedation_v2_data', JSON.stringify(patientData));
            }
            function loadState() {
                const saved = localStorage.getItem('sedation_v2_data');
                if(saved) {
                    try {
                        patientData = { ...patientData, ...JSON.parse(saved) };
                        restoreUI();
                        updateNotes();
                    } catch(e) { console.error(e); }
                }
            }

            // --- UI RESTORE ---
            function restoreUI() {
                const p = patientData;
                // PT
                setVal('pt_age', p.pt.age);
                setVal('pt_weight', p.pt.weight);
                setCheck('pt_estWeight', p.pt.estWeight);
                setVal('pt_allergies', p.pt.allergies);
                setVal('pt_procedure', p.pt.procedure);
                setVal('pt_indication', p.pt.indication);
                setVal('pt_preAnalgesia', p.pt.preAnalgesia);
                // Staff
                setVal('st_sed', p.staff.sed);
                setVal('st_grade', p.staff.grade);
                setVal('st_doc', p.staff.doc);
                setVal('st_nurse', p.staff.nurse);
                // Assess
                setRadio('ass_capacity', p.assess.capacity);
                setRadio('ass_mallampati', p.assess.mallampati);
                setRadio('ass_ulbt', p.assess.ulbt);
                setRadio('ass_asa', p.assess.asa);
                setVal('ass_lastFood', p.assess.lastFood);
                setVal('ass_lastFluid', p.assess.lastFluid);
                p.assess.predictors.forEach(v => checkVal('.pred-chk', v));
                p.assess.risks.forEach(v => checkVal('.risk-chk', v));
                // Plan
                p.plan.soap.forEach(v => checkVal('.soap-chk', v));
                p.plan.timeout.forEach(v => checkVal('.time-chk', v));
                setVal('pv_hr', p.plan.preVitals.hr);
                setVal('pv_bp', p.plan.preVitals.bp);
                setVal('pv_spo2', p.plan.preVitals.spo2);
                setVal('pv_rr', p.plan.preVitals.rr);
                // Proc
                setVal('general-notes', p.proc.notes);
                if(p.proc.start) $('out-proc-start').textContent = p.proc.start;
                if(p.proc.end) $('out-proc-end').textContent = p.proc.end;
                if(p.proc.awake) $('out-awake').textContent = p.proc.awake;
                renderDrugs();
                renderObs();
                // Agitated
                setVal('ag_weight', p.agitated.weight);
                if(p.agitated.weight) calcAgitated(p.agitated.weight);
                // DC
                setRadio('outcome', p.dc.outcome);
                p.dc.criteria.forEach(v => checkVal('.dc-chk', v));
                setVal('dc_signName', p.dc.signName);
                setVal('dc_signTime', p.dc.signTime);
                
                // Timer
                if(p.timer.running) startTimerUI();
                else if(p.timer.pausedElapsed > 0) updateTimerDisplay(p.timer.pausedElapsed);

                updateAirwayUI();
            }

            // --- BINDINGS ---
            // Inputs
            const bind = (id, cat, key) => $(id).addEventListener('input', e => { patientData[cat][key] = e.target.value; updateNotes(); saveState(); });
            const bindChk = (id, cat, key) => $(id).addEventListener('change', e => { patientData[cat][key] = e.target.checked; updateNotes(); saveState(); });
            const bindRadio = (name, cat, key) => document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.addEventListener('change', e => { patientData[cat][key] = e.target.value; updateNotes(); saveState(); updateAirwayUI(); }));
            const bindArr = (cls, cat, key) => document.querySelectorAll(cls).forEach(c => c.addEventListener('change', e => { 
                if(e.target.checked) patientData[cat][key].push(e.target.value);
                else patientData[cat][key] = patientData[cat][key].filter(x => x !== e.target.value);
                updateNotes(); saveState(); updateAirwayUI();
            }));

            // Apply Bindings
            bind('pt_age', 'pt', 'age'); bind('pt_weight', 'pt', 'weight'); bindChk('pt_estWeight', 'pt', 'estWeight');
            bind('pt_allergies', 'pt', 'allergies'); bind('pt_procedure', 'pt', 'procedure'); bind('pt_indication', 'pt', 'indication'); bind('pt_preAnalgesia', 'pt', 'preAnalgesia');
            bind('st_sed', 'staff', 'sed'); bind('st_grade', 'staff', 'grade'); bind('st_doc', 'staff', 'doc'); bind('st_nurse', 'staff', 'nurse');
            bindRadio('ass_capacity', 'assess', 'capacity'); bindRadio('ass_mallampati', 'assess', 'mallampati'); bindRadio('ass_ulbt', 'assess', 'ulbt'); bindRadio('ass_asa', 'assess', 'asa');
            bind('ass_lastFood', 'assess', 'lastFood'); bind('ass_lastFluid', 'assess', 'lastFluid');
            bindArr('.pred-chk', 'assess', 'predictors'); bindArr('.risk-chk', 'assess', 'risks');
            bindArr('.soap-chk', 'plan', 'soap'); bindArr('.time-chk', 'plan', 'timeout');
            bind('pv_hr', 'plan', 'preVitals'); bind('pv_bp', 'plan', 'preVitals'); // Note: Nested obj needs specific handler if deep, simplified here:
            ['hr','bp','spo2','rr'].forEach(k => $(`pv_${k}`).addEventListener('input', e => { patientData.plan.preVitals[k] = e.target.value; updateNotes(); saveState(); }));
            
            bind('general-notes', 'proc', 'notes');
            bind('ag_weight', 'agitated', 'weight'); $('ag_weight').addEventListener('input', e => calcAgitated(e.target.value));
            
            bindRadio('outcome', 'dc', 'outcome'); bindArr('.dc-chk', 'dc', 'criteria');
            bind('dc_signName', 'dc', 'signName'); bind('dc_signTime', 'dc', 'signTime');

            // --- NOTE GENERATOR (THE CORE LOGIC) ---
            function updateNotes() {
                const p = patientData;
                let h = `<strong>Procedural Sedation Record</strong><br>`;
                
                // Patient
                h += `Patient: ${p.pt.age || '?'}yr | ${p.pt.weight || '?'}kg ${p.pt.estWeight?'(Est)':''} | ASA ${p.assess.asa || '-'}.<br>`;
                if(p.pt.allergies) h += `<strong>ALLERGIES: ${p.pt.allergies}</strong><br>`;
                h += `Procedure: ${p.pt.procedure} (${p.pt.indication}).<br>`;
                h += `Staff: ${p.staff.sed} (Sed), ${p.staff.doc} (Proc), ${p.staff.nurse} (Nrs).<br>`;
                
                // Assessment
                if(p.assess.mallampati || p.assess.ulbt || p.assess.predictors.length > 0) {
                    h += `Airway: Mallampati ${p.assess.mallampati || '-'}, ULBT ${p.assess.ulbt || '-'}. `;
                    if(p.assess.predictors.length) h += `Predictors: ${p.assess.predictors.join(', ')}. `;
                    h += `<br>`;
                }
                if(p.assess.risks.length) h += `Risks Discussed: ${p.assess.risks.join(', ')}.<br>`;
                h += `Fasting: Food ${p.assess.lastFood || '-'} | Fluid ${p.assess.lastFluid || '-'}.<br>`;
                
                // Plan
                h += `Checks: SOAP-ME [${p.plan.soap.length}/5] | Time Out [${p.plan.timeout.length}/4].<br>`;
                const pv = p.plan.preVitals;
                if(pv.hr || pv.bp) h += `Pre-Vitals: HR${pv.hr} BP${pv.bp} SpO2${pv.spo2}% RR${pv.rr}.<br>`;
                
                // Procedure
                h += `<br><strong>Procedure Log</strong><br>`;
                if(p.proc.drugs.length > 0) {
                    h += `Drugs:<br>`;
                    p.proc.drugs.forEach(d => h += `- ${d.time}: ${d.name} ${d.dose}<br>`);
                } else h += `No drugs recorded.<br>`;
                
                if(p.proc.obs.length > 0) {
                    h += `Observations:<br>`;
                    p.proc.obs.forEach(o => h += `- ${o.time}: HR${o.hr} BP${o.bp} SpO2${o.spo2}% RR${o.rr}<br>`);
                }
                
                if(p.proc.start || p.proc.end) h += `Times: Start ${p.proc.start || '-'} | End ${p.proc.end || '-'} | Awake ${p.proc.awake || '-'}.<br>`;
                if(p.proc.notes) h += `Notes: ${p.proc.notes}<br>`;
                
                // Outcome
                h += `<br><strong>Discharge</strong><br>`;
                h += `Outcome: ${p.dc.outcome}. `;
                if(p.dc.criteria.length) h += `Criteria: ${p.dc.criteria.join(', ')}. `;
                if(p.dc.signName) h += `Signed: ${p.dc.signName} @ ${p.dc.signTime}.`;

                $('epr-log-output').innerHTML = h;
            }

            // --- LOGIC HELPERS ---
            function setVal(id, v) { if($(id)) $(id).value = v || ''; }
            function setCheck(id, v) { if($(id)) $(id).checked = !!v; }
            function setRadio(name, v) { const el = document.querySelector(`input[name="${name}"][value="${v}"]`); if(el) el.checked = true; }
            function checkVal(cls, v) { const el = document.querySelector(`${cls}[value="${v}"]`); if(el) el.checked = true; }
            
            function updateAirwayUI() {
                const m = patientData.assess.mallampati;
                const ulbt = patientData.assess.ulbt;
                const asa = patientData.assess.asa;
                const preds = patientData.assess.predictors.length > 0;
                const risk = (m==='III'||m==='IV'||ulbt==='3'||asa==='III'||asa==='IV'||preds);
                $('airway-card').className = `p-3 border rounded-lg mb-4 transition-colors duration-300 ${risk ? 'bg-orange-50 border-orange-300 dark:bg-orange-900/20' : 'bg-slate-50 border-slate-200 dark:bg-slate-700/30'}`;
            }

            function calcAgitated(w) {
                if(w > 0) {
                    $('val-ket-im').textContent = (w * 4).toFixed(0);
                    $('val-ket-iv').textContent = (w * 1).toFixed(0);
                    $('agitated-output').classList.remove('hidden');
                } else $('agitated-output').classList.add('hidden');
            }

            // --- DRUGS & OBS ---
            const renderDrugs = () => {
                const c = $('drug-table-container'); c.innerHTML = '';
                $('empty-drugs-msg').classList.toggle('hidden', patientData.proc.drugs.length > 0);
                patientData.proc.drugs.forEach((d, idx) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-blue-50 dark:bg-blue-900/20 p-2 rounded border border-blue-100 dark:border-blue-800 text-sm mb-1';
                    div.innerHTML = `<div class="flex gap-3 items-center"><span class="font-mono text-xs text-blue-400">${d.time}</span><span class="font-bold text-blue-900 dark:text-blue-100">${d.name}</span><span class="font-black text-slate-800 dark:text-white">${d.dose}</span></div><button class="text-red-400 hover:text-red-600 font-bold px-2 remove-drug" data-idx="${idx}">√ó</button>`;
                    c.appendChild(div);
                });
                document.querySelectorAll('.remove-drug').forEach(b => b.onclick = e => {
                    patientData.proc.drugs.splice(e.target.dataset.idx, 1);
                    renderDrugs(); updateNotes(); saveState();
                });
            };

            const renderObs = () => {
                const c = $('obs-table-container'); c.innerHTML = '';
                patientData.proc.obs.forEach((o, idx) => {
                    const div = document.createElement('div');
                    div.className = 'grid grid-cols-6 gap-1 items-center bg-slate-50 dark:bg-slate-700/50 p-2 rounded border border-slate-200 dark:border-slate-600 text-xs mb-1';
                    div.innerHTML = `
                        <div class="col-span-1 font-mono font-bold text-slate-500">${o.time}</div>
                        <input type="number" placeholder="HR" class="col-span-1 p-1 text-center font-bold rounded border dark:bg-slate-600 dark:border-slate-500 obs-inp" data-idx="${idx}" data-field="hr" value="${o.hr}">
                        <input type="number" placeholder="BP" class="col-span-1 p-1 text-center font-bold rounded border dark:bg-slate-600 dark:border-slate-500 obs-inp" data-idx="${idx}" data-field="bp" value="${o.bp}">
                        <input type="number" placeholder="SpO2" class="col-span-1 p-1 text-center font-bold rounded border dark:bg-slate-600 dark:border-slate-500 obs-inp" data-idx="${idx}" data-field="spo2" value="${o.spo2}">
                        <input type="number" placeholder="RR" class="col-span-1 p-1 text-center font-bold rounded border dark:bg-slate-600 dark:border-slate-500 obs-inp" data-idx="${idx}" data-field="rr" value="${o.rr}">
                        <div class="col-span-1 text-center"><button class="text-red-500 font-bold px-2 py-1 bg-red-50 rounded hover:bg-red-100 dark:bg-slate-800 remove-obs" data-idx="${idx}">√ó</button></div>
                    `;
                    c.appendChild(div);
                });
                document.querySelectorAll('.obs-inp').forEach(i => i.oninput = e => {
                    patientData.proc.obs[e.target.dataset.idx][e.target.dataset.field] = e.target.value;
                    updateNotes(); saveState();
                });
                document.querySelectorAll('.remove-obs').forEach(b => b.onclick = e => {
                    patientData.proc.obs.splice(e.target.dataset.idx, 1);
                    renderObs(); updateNotes(); saveState();
                });
            };

            // Add Drug Logic
            let selDrug = null;
            $('footer-drug-btn').onclick = () => { $('drug-modal').classList.remove('hidden'); $('drug-modal').classList.add('flex'); };
            $('close-drug-modal').onclick = () => $('drug-modal').classList.add('hidden');
            document.querySelectorAll('.drug-select-btn').forEach(b => b.onclick = () => {
                document.querySelectorAll('.drug-select-btn').forEach(x=>x.classList.remove('ring-4','ring-blue-400'));
                b.classList.add('ring-4','ring-blue-400');
                selDrug = b.dataset.drug;
                $('quick-drug-dose').focus();
            });
            $('confirm-drug-btn').onclick = () => {
                const dose = $('quick-drug-dose').value;
                if(selDrug && dose) {
                    patientData.proc.drugs.push({ time: getTime(), name: selDrug, dose: dose + (selDrug==='Fentanyl'?'mcg':'mg') });
                    $('drug-modal').classList.add('hidden');
                    $('quick-drug-dose').value = '';
                    renderDrugs(); updateNotes(); saveState();
                }
            };

            // Add Obs Logic
            $('footer-obs-btn').onclick = () => {
                patientData.proc.obs.push({ time: getTime(), hr:'', bp:'', spo2:'', rr:'' });
                renderObs(); updateNotes(); saveState();
            };

            // --- TIMER ---
            let timerInt = null;
            const updateTimerDisplay = (s) => {
                const m = Math.floor(s/60).toString().padStart(2,'0');
                const sec = (s%60).toString().padStart(2,'0');
                $('timer-display').textContent = `${m}:${sec}`;
                $('footer-timer').textContent = `${m}:${sec}`;
            };
            function startTimerUI() {
                $('sedation-timer-button').textContent = "STOP TIMER";
                $('sedation-timer-button').classList.replace('bg-green-600', 'bg-red-600');
                $('sedation-timer-button').classList.replace('border-green-800', 'border-red-800');
                $('sticky-footer').classList.replace('translate-y-full', 'translate-y-0');
                timerInt = setInterval(() => {
                    const diff = Math.floor((Date.now() - patientData.timer.start)/1000) + patientData.timer.pausedElapsed;
                    updateTimerDisplay(diff);
                }, 1000);
            }
            $('sedation-timer-button').onclick = () => {
                if(patientData.timer.running) {
                    // STOP
                    clearInterval(timerInt);
                    patientData.timer.pausedElapsed += Math.floor((Date.now() - patientData.timer.start)/1000);
                    patientData.timer.running = false;
                    $('sedation-timer-button').textContent = "RESUME TIMER";
                    $('sedation-timer-button').classList.replace('bg-red-600', 'bg-green-600');
                    $('sedation-timer-button').classList.replace('border-red-800', 'border-green-800');
                } else {
                    // START
                    patientData.timer.start = Date.now();
                    patientData.timer.running = true;
                    if(patientData.proc.drugs.length===0 && patientData.proc.obs.length===0) {
                        // First start logic: Open accordions
                        ['section-1-content','section-2-content','section-3-content'].forEach(id => {
                            $(id).style.maxHeight = $(id).scrollHeight + "px"; $(id).classList.remove('opacity-50');
                        });
                        patientData.proc.obs.push({ time: getTime(), hr:'', bp:'', spo2:'', rr:'' });
                        renderObs();
                    }
                    startTimerUI();
                }
                saveState();
            };

            // Timestamp buttons
            ['btn-proc-start','btn-proc-end','btn-awake'].forEach(id => $(id).onclick = () => {
                const k = id.replace('btn-proc-','').replace('btn-','');
                patientData.proc[k] = getTime();
                $(`out-${id.replace('btn-','')}`).textContent = patientData.proc[k];
                updateNotes(); saveState();
            });

            // Utils
            window.setNow = (id) => { $(id).value = getTime(); $(id).dispatchEvent(new Event('input')); };
            window.toggleSection = (id) => {
                const el = $(id);
                if(el.style.maxHeight){ el.style.maxHeight=null; el.classList.add('opacity-50'); }
                else { el.style.maxHeight=el.scrollHeight+"px"; el.classList.remove('opacity-50'); }
            };
            window.scrollToSection = (id) => {
                const el = $(id);
                if(el.classList.contains('transition-height')) { el.style.maxHeight=el.scrollHeight+"px"; el.classList.remove('opacity-50'); el.previousElementSibling.scrollIntoView({behavior:'smooth'}); }
                else el.scrollIntoView({behavior:'smooth', block:'center'});
            };
            
            // --- UPDATED COPY FUNCTION ---
            $('copy-log-button').onclick = async () => {
                const el = $('epr-log-output');
                try {
                    const htmlBlob = new Blob([el.innerHTML], { type: 'text/html' });
                    const textBlob = new Blob([el.innerText], { type: 'text/plain' });
                    await navigator.clipboard.write([
                        new ClipboardItem({ 
                            'text/html': htmlBlob, 
                            'text/plain': textBlob 
                        })
                    ]);
                    const b = $('copy-log-button'); const t = b.innerText; b.innerText="‚úÖ COPIED!"; b.classList.replace('bg-blue-600','bg-green-600');
                    setTimeout(()=>{ b.innerText=t; b.classList.replace('bg-green-600','bg-blue-600'); }, 2000);
                } catch (err) {
                    alert('Copy failed. Please manually select the text.');
                }
            };

            $('reset-btn').onclick = () => { if(confirm('Reset all data?')) { localStorage.removeItem('sedation_v2_data'); location.reload(); }};
            
            // Tab Logic
            $('btn-tab-procedural').onclick = () => { $('tab-procedural').classList.remove('hidden'); $('tab-agitated').classList.add('hidden'); $('btn-tab-procedural').classList.add('border-blue-600','text-blue-800'); $('btn-tab-procedural').classList.remove('border-transparent','text-slate-500'); $('btn-tab-agitated').classList.remove('border-red-600','text-red-800'); $('btn-tab-agitated').classList.add('border-transparent','text-slate-500'); };
            $('btn-tab-agitated').onclick = () => { $('tab-agitated').classList.remove('hidden'); $('tab-procedural').classList.add('hidden'); $('btn-tab-agitated').classList.add('border-red-600','text-red-800'); $('btn-tab-agitated').classList.remove('border-transparent','text-slate-500'); $('btn-tab-procedural').classList.remove('border-blue-600','text-blue-800'); $('btn-tab-procedural').classList.add('border-transparent','text-slate-500'); };

            // Dark Mode Toggle
            const toggleDark = $('dark-mode-toggle');
            const htmlEl = document.documentElement;
            if(localStorage.getItem('dark-mode') === 'true') htmlEl.classList.add('dark');
            toggleDark.onclick = () => {
                htmlEl.classList.toggle('dark');
                localStorage.setItem('dark-mode', htmlEl.classList.contains('dark'));
            };

            loadState();
        });
    </script>
</body>
</html>
